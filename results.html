<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allnspyre | Results</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; background:#faf9f7; color:#111; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 28px 18px 80px; }
    .top { display:flex; justify-content:space-between; align-items:flex-start; gap:16px; flex-wrap:wrap; margin-bottom:18px; }
    .meta { font-size: 12px; color:#555; display:flex; gap:18px; flex-wrap:wrap; }
    .meta b { color:#111; font-weight:600; }
    h1 { font-family: ui-serif, Georgia, "Times New Roman", serif; font-size: 56px; letter-spacing:-0.02em; margin: 10px 0 4px; }
    .sub { color:#666; margin-bottom:18px; }
    .actions { display:flex; gap:10px; }
    .btn { padding:10px 14px; border-radius: 999px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:600; }
    .btn.primary { background:#111; color:#fff; border-color:#111; }
    .state { margin-top:14px; padding:12px 14px; border-radius: 12px; background:#fff; border:1px solid #eee; font-size:13px; white-space:pre-wrap; }
    .state.bad { border-color:#f1b1b1; background:#fff5f5; color:#8b0000; }
    .grid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:14px; margin-top:18px; }
    @media (max-width: 740px){ .grid{ grid-template-columns: 1fr; } h1{font-size:42px;} }
    .card { background:#fff; border:1px solid #eee; border-radius: 18px; overflow:hidden; box-shadow: 0 8px 24px rgba(0,0,0,.04); }
    .img { aspect-ratio: 16 / 10; background:#f3f2ee; }
    .card .in { padding:14px 14px 16px; }
    .name { font-weight:800; font-size:18px; margin:0 0 6px; }
    .desc { margin:0 0 10px; color:#444; line-height:1.5; }
    .tags { display:flex; flex-wrap:wrap; gap:8px; }
    .tag { font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #eee; background:#fafafa; color:#333; }
    .debug { margin-top:18px; font-size:12px; color:#666; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="meta" id="meta"></div>
      <div class="actions">
        <button class="btn" id="btnRetry">Retry</button>
        <button class="btn" id="btnBack">Back to Hearing</button>
      </div>
    </div>

    <h1>Your 7 picks.</h1>
    <div class="sub">Where locals actually eat — before the world finds out.</div>

    <div id="state" class="state">Loading…</div>
    <div id="grid" class="grid"></div>

    <div class="debug" id="debug"></div>
  </div>

<script>
  const API_BASE = location.origin; // allnspyre-api.vercel.app
  const $ = (id) => document.getElementById(id);

  function getPlanFromQuery() {
    const p = new URLSearchParams(location.search).get("plan");
    return (p || "").toLowerCase() || "explorer";
  }

  // localStorageのキー揺れ吸収（今後の事故防止）
  function readHearingPayload() {
    const keys = [
      "hearingData",
      "allnspyre_hearing",
      "allnspyre hearing",
      "hearing",
    ];
    for (const k of keys) {
      const raw = localStorage.getItem(k);
      if (!raw) continue;
      try { return JSON.parse(raw); } catch (e) {}
    }
    return null;
  }

  // ✅ここが本丸：api/results が必須にしてる areaDetails を必ず作る
  function normalizeForApi(payload) {
    const plan = (payload?.plan || getPlanFromQuery() || "explorer").toLowerCase();

    const prefs = Array.isArray(payload?.prefs) ? payload.prefs : [];
    const who = payload?.who || "";
    const mood = payload?.mood || "";
    const avoid = Array.isArray(payload?.avoid) ? payload.avoid : [];

    // hearing側のUIは "Tokyo Urban" みたいな「広域グループ」を選ばせてる
    // それをサーバー側の必須パラメータ areaDetails として送る（名前合わせ）
    const areaGroups =
      Array.isArray(payload?.areas) ? payload.areas :
      Array.isArray(payload?.areaGroups) ? payload.areaGroups :
      Array.isArray(payload?.areaDetails) ? payload.areaDetails :
      [];

    const areaDetails = areaGroups; // ✅必須

    return { plan, prefs, areaDetails, who, mood, avoid };
  }

  function setMeta({plan, prefs, areaDetails}) {
    const areasText = (areaDetails || []).join(" / ");
    const prefsText = (prefs || []).join(" / ");
    $("meta").innerHTML = `
      <div><b>PLAN:</b> ${escapeHtml(plan || "")}</div>
      <div><b>PREFS:</b> ${escapeHtml(prefsText || "-")}</div>
      <div><b>AREAS:</b> ${escapeHtml(areasText || "-")}</div>
    `;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  async function fetchResults(apiPayload) {
    const url = `${API_BASE}/api/results`;
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(apiPayload),
    });

    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch(e) {}

    return { ok: res.ok, status: res.status, text, json };
  }

  function renderCards(records) {
    const grid = $("grid");
    grid.innerHTML = "";
    for (const r of records) {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="img"></div>
        <div class="in">
          <p class="name">${escapeHtml(r.shop_name || r.name || "Store")}</p>
          <p class="desc">${escapeHtml(r.short_desc || r.desc || "")}</p>
          <div class="tags">
            ${r.genre ? `<span class="tag">${escapeHtml(r.genre)}</span>` : ""}
            ${r.area_group ? `<span class="tag">${escapeHtml(r.area_group)}</span>` : ""}
            ${r.{area_group} ? `<span class="tag">${escapeHtml(r.{area_group})}</span>` : ""}
          </div>
        </div>
      `;
      grid.appendChild(card);
    }
  }

  async function run() {
    $("state").className = "state";
    $("state").textContent = "Loading…";

    const rawPayload = readHearingPayload();
    if (!rawPayload) {
      $("state").className = "state bad";
      $("state").textContent =
        "No hearing data found.\n\n" +
        "Fix:\n" +
        "1) Go back to hearing and select again.\n" +
        "2) Make sure you are on the same domain (allnspyre-api.vercel.app)\n";
      setMeta({ plan: getPlanFromQuery(), prefs: [], areaDetails: [] });
      return;
    }

    const apiPayload = normalizeForApi(rawPayload);
    setMeta(apiPayload);

    // ✅ areaDetails が空ならサーバーが必ず落とすので、先に止める
    if (!apiPayload.areaDetails || apiPayload.areaDetails.length === 0) {
      $("state").className = "state bad";
      $("state").textContent =
        "Missing areas.\n\n" +
        "You must pick at least 1 area group on hearing.\n";
      $("debug").innerHTML = `<div class="mono">payload=${escapeHtml(JSON.stringify(apiPayload, null, 2))}</div>`;
      return;
    }

    const out = await fetchResults(apiPayload);

    if (!out.ok) {
      $("state").className = "state bad";
      // サーバーが返すJSONエラーをそのまま見せる
      if (out.json && out.json.error) {
        $("state").textContent = `Failed ❌\nAPI ${out.status}\n${out.json.error}`;
      } else {
        $("state").textContent = `Failed ❌\nAPI ${out.status}\n(non-JSON or non-200)\n\n${out.text.slice(0, 300)}`;
      }
      $("debug").innerHTML = `<div class="mono">payload=${escapeHtml(JSON.stringify(apiPayload, null, 2))}</div>`;
      return;
    }

    const json = out.json || {};
    const records = Array.isArray(json.records) ? json.records : (Array.isArray(json) ? json : []);
    if (!records.length) {
      $("state").className = "state bad";
      $("state").textContent = "API returned no records.";
      $("debug").innerHTML = `<div class="mono">response=${escapeHtml(out.text.slice(0, 500))}</div>`;
      return;
    }

    renderCards(records);
    $("state").className = "state";
    $("state").textContent = `OK ✅\nrecords: ${records.length}`;
    $("debug").innerHTML = "";
  }

  $("btnRetry").addEventListener("click", run);
  $("btnBack").addEventListener("click", () => {
    const plan = getPlanFromQuery();
    location.href = `${API_BASE}/hearing.html?plan=${encodeURIComponent(plan)}`;
  });

  run();
</script>
</body>
</html>
