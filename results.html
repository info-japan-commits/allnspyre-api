<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allnspyre | Results</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f7f6f2; color:#111; margin:0; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 26px 18px 60px; }
    h1 { font-family: Georgia, "Times New Roman", serif; font-size: 56px; margin: 10px 0 8px; }
    .sub { color:#555; margin-bottom: 16px; }
    .topline { display:flex; gap:12px; flex-wrap:wrap; align-items:center; color:#444; font-size: 14px; }
    .pill { padding: 6px 10px; border-radius:999px; border:1px solid #e9e6dc; background:#fff; }
    .actions { margin-left:auto; display:flex; gap:10px; }
    a.btn { text-decoration:none; padding: 10px 12px; border-radius: 999px; border:1px solid #ddd; background:#fff; color:#111; }
    .card { background:#fff; border:1px solid #e9e6dc; border-radius: 18px; padding: 16px; box-shadow: 0 6px 22px rgba(0,0,0,.05); margin-top: 14px; }
    .err { border:1px solid #ffd2d2; background:#fff6f6; color:#b00020; padding: 12px; border-radius: 14px; }
    .grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 14px; margin-top: 14px; }
    @media (max-width: 760px){ .grid{ grid-template-columns:1fr; } }
    .shop { border:1px solid #eee; border-radius: 16px; padding: 14px; }
    .name { font-family: Georgia, "Times New Roman", serif; font-size: 22px; margin:0 0 6px; }
    .desc { color:#444; margin:0 0 10px; line-height:1.55; }
    .meta { display:flex; gap:8px; flex-wrap:wrap; color:#666; font-size: 12px; }
    .tag { border:1px solid #eee; border-radius:999px; padding: 5px 8px; background:#fff; }
    .hint { color:#666; font-size: 12px; margin-top: 10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topline">
      <div class="pill" id="planPill">PLAN: —</div>
      <div class="pill" id="prefsPill">PREFS: —</div>
      <div class="pill" id="areasPill">AREAS: —</div>
      <div class="actions">
        <a class="btn" href="#" id="retryBtn">Retry</a>
        <a class="btn" href="/hearing.html" id="backBtn">Back to Hearing</a>
      </div>
    </div>

    <h1>Your 7 picks.</h1>
    <div class="sub">Where locals actually eat — before the world finds out.</div>

    <div id="status" class="card">Loading…</div>

    <div id="grid" class="grid" style="display:none;"></div>

    <div id="debug" class="card" style="display:none;">
      <div class="hint">debug</div>
      <div class="mono" id="debugText"></div>
    </div>
  </div>

<script>
(() => {
  const API = location.origin;
  const KEY = "allnspyre_hearing";

  const qs = new URLSearchParams(location.search);
  const planFromUrl = (qs.get("plan") || "").toLowerCase(); // Stripe Success URLで ?plan=... が付いてもOK

  const planPill = document.getElementById("planPill");
  const prefsPill = document.getElementById("prefsPill");
  const areasPill = document.getElementById("areasPill");
  const statusEl = document.getElementById("status");
  const gridEl = document.getElementById("grid");
  const retryBtn = document.getElementById("retryBtn");
  const dbg = document.getElementById("debug");
  const dbgText = document.getElementById("debugText");

  function setStatus(html, isErr=false){
    statusEl.className = "card" + (isErr ? " err" : "");
    statusEl.innerHTML = html;
  }

  function safeJson(s){
    try { return JSON.parse(s); } catch { return null; }
  }

  function loadHearing(){
    const raw = localStorage.getItem(KEY);
    const data = safeJson(raw);
    if(!data) return null;
    // planはURLが優先（Stripe Success URLが plan固定なので）
    if(planFromUrl) data.plan = planFromUrl;
    return data;
  }

  function renderHeader(data){
    planPill.textContent = "PLAN: " + (data.plan || "—");
    prefsPill.textContent = "PREFS: " + ((data.prefs || []).join(" / ") || "—");
    areasPill.textContent = "AREAS: " + ((data.areaGroups || []).join(" / ") || "—");
  }

  function renderShops(shops){
    gridEl.innerHTML = "";
    shops.forEach(s => {
      const div = document.createElement("div");
      div.className = "shop";
      div.innerHTML = `
        <h3 class="name">${escapeHtml(s.shop_name || "—")}</h3>
        <p class="desc">${escapeHtml(s.short_desc || "")}</p>
        <div class="meta">
          <span class="tag">${escapeHtml(s.area_group || "")}</span>
          <span class="tag">${escapeHtml(s.genre || "")}</span>
          <span class="tag">${escapeHtml(s.photo_status || "none")}</span>
        </div>
      `;
      gridEl.appendChild(div);
    });
    gridEl.style.display = "grid";
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function fetchResults(){
    gridEl.style.display = "none";
    setStatus("Loading…");

    const data = loadHearing();
    if(!data){
      return setStatus(`Failed ✕<br><br>Missing hearing data (localStorage: <b>${KEY}</b>).<br><a href="/hearing.html">Go to hearing</a>`, true);
    }

    // 必須：prefs と areaGroups（= area_group）
    if(!(data.prefs||[]).length) return setStatus("Failed ✕<br><br>No prefs provided", true);
    if(!(data.areaGroups||[]).length) return setStatus("Failed ✕<br><br>No areaGroups provided", true);

    renderHeader(data);

    const body = {
      plan: data.plan,
      prefs: data.prefs,
      areaGroups: data.areaGroups,  // ← ここがポイント（area_detailじゃない）
      who: data.who || "",
      mood: data.mood || "",
      avoid: data.avoid || ""
    };

    const r = await fetch(API + "/api/results", {
      method: "POST",
      headers: { "content-type":"application/json" },
      body: JSON.stringify(body)
    });

    const text = await r.text();
    const j = safeJson(text);

    // debug出す（社長が確認できるように）
    dbg.style.display = "block";
    dbgText.textContent = `status=${r.status}\nresponse=${text}`;

    if(!j || !j.ok){
      return setStatus(`Failed ✕<br><br>API error (non-JSON or non-200)<br><div class="hint">See debug below</div>`, true);
    }

    if((j.shops||[]).length === 0){
      setStatus(`API returned no records.<br><div class="hint">See debug below</div>`, true);
      return;
    }

    setStatus("Success ✓");
    renderShops(j.shops || []);
  }

  retryBtn.addEventListener("click", (e) => { e.preventDefault(); fetchResults(); });

  fetchResults().catch(e => setStatus("Failed ✕<br><br>"+escapeHtml(String(e)), true));
})();
</script>
</body>
</html>
