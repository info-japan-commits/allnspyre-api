<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allnspyre | Your 7 picks</title>
  <style>
    :root{
      --bg:#f7f5f1;
      --card:#ffffff;
      --text:#111;
      --muted:#6b6b6b;
      --line:#e8e5df;
      --danger:#c62828;
      --radius:20px;
      --shadow: 0 14px 34px rgba(17,17,17,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: linear-gradient(180deg, #fbfaf7 0%, var(--bg) 100%);
    }

    /* top */
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 80px;}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
    .chip{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background:#fff;
      padding:6px 10px;border-radius:999px;
    }
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      line-height:1;
    }
    .btn:hover{filter:brightness(0.98)}

    h1{
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      font-size:64px;
      letter-spacing:-0.02em;
      margin:10px 0 8px;
      line-height:1.0;
    }
    .sub{color:var(--muted);margin:0 0 14px}

    .progress{
      display:flex;
      gap:10px;
      align-items:center;
      color:var(--muted);
      font-size:13px;
      margin-top:10px;
    }
    .dotbar{display:flex;gap:6px;align-items:center;}
    .dot{
      width:6px;height:6px;border-radius:999px;
      background:rgba(17,17,17,.12);
    }
    .dot.active{background:rgba(17,17,17,.65);}

    .alert{
      border:1px solid #f2b8b5;
      background:#fff3f3;
      color:var(--danger);
      padding:14px 16px;
      border-radius:14px;
      margin:18px 0;
      display:none;
    }

    /* immersive deck */
    .deck{
      margin-top:16px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: rgba(255,255,255,.55);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .slide{
      height: calc(100vh - 230px);
      min-height: 540px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      background: #fff;
    }

    @media (max-width: 960px){
      h1{font-size:44px}
      .slide{
        grid-template-columns: 1fr;
        height: auto;
        min-height: unset;
      }
    }
    @media (max-width: 600px){
      h1{font-size:38px}
    }

    .media{
      position:relative;
      background: linear-gradient(180deg, rgba(17,17,17,.06), rgba(17,17,17,.02));
      min-height: 320px;
    }
    .media img{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
    }

    .pane{
      padding:22px 22px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
      background: rgba(255,255,255,.88);
    }

    .name{
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      font-size:30px;
      margin:0;
      line-height:1.18;
      letter-spacing:-0.01em;
    }
    .meta{
      font-size:14px;color:var(--muted);
      margin:0;
    }

    .note{
      margin:8px 0 0;
      color:var(--text);
      font-size:14px;
      line-height:1.65;
    }

    .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .tag{
      font-size:12px;color:var(--text);
      border:1px solid var(--line);
      background:#fff;
      padding:6px 10px;border-radius:999px;
    }

    .nav{
      margin-top:auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding-top:14px;
      border-top:1px solid rgba(232,229,223,.7);
    }
    .hint{color:var(--muted);font-size:12px;}

    /* skeleton */
    .skeleton{
      height: calc(100vh - 230px);
      min-height: 540px;
      background: linear-gradient(90deg, #ffffff 0%, #f3f1ec 50%, #ffffff 100%);
      background-size: 200% 200%;
      animation: shimmer 1.2s infinite linear;
    }
    @keyframes shimmer{
      0%{background-position:0% 0%}
      100%{background-position:100% 0%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="chips" id="chips">
        <span class="chip">PLAN: —</span>
        <span class="chip">PREFS: —</span>
        <span class="chip">AREAS: —</span>
      </div>
      <div class="actions">
        <button class="btn" id="prevBtn">←</button>
        <button class="btn" id="nextBtn">→</button>
        <button class="btn" id="retryBtn">Retry</button>
        <button class="btn" id="backBtn">Back to Hearing</button>
      </div>
    </div>

    <h1>Your 7 picks.</h1>
    <p class="sub">Where locals actually eat — before the world finds out.</p>

    <div class="progress">
      <span id="progressText">—</span>
      <span class="dotbar" id="dotbar"></span>
      <span class="hint">Use ← → keys / swipe</span>
    </div>

    <div class="alert" id="alertBox">
      <strong>Failed</strong>
      <div id="alertMsg" style="margin-top:6px;"></div>
    </div>

    <div class="deck" id="deck">
      <div class="skeleton"></div>
    </div>
  </div>

<script>
  const deck = document.getElementById("deck");
  const alertBox = document.getElementById("alertBox");
  const alertMsg = document.getElementById("alertMsg");
  const chips = document.getElementById("chips");

  const retryBtn = document.getElementById("retryBtn");
  const backBtn = document.getElementById("backBtn");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  const progressText = document.getElementById("progressText");
  const dotbar = document.getElementById("dotbar");

  let shopsCache = [];
  let idx = 0;

  function setError(message){
    alertMsg.textContent = message || "Unknown error";
    alertBox.style.display = "block";
  }

  function clearError(){
    alertBox.style.display = "none";
    alertMsg.textContent = "";
  }

  function setLoading(){
    deck.innerHTML = `<div class="skeleton"></div>`;
    if(progressText) progressText.textContent = "—";
    if(dotbar) dotbar.innerHTML = "";
  }

  function setChips(plan, prefs, areas){
    chips.innerHTML = `
      <span class="chip">PLAN: ${plan || "—"}</span>
      <span class="chip">PREFS: ${prefs || "—"}</span>
      <span class="chip">AREAS: ${areas || "—"}</span>
    `;
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function toArray(v){
    if (Array.isArray(v)) return v.filter(Boolean);
    if (typeof v === "string" && v.trim()) return v.split(",").map(s=>s.trim()).filter(Boolean);
    return [];
  }

  function buildTags(shop){
    const tier = shop.tier ? [shop.tier] : [];
    const slot = shop.time_slot ? [shop.time_slot] : [];
    const bw = toArray(shop.best_with);
    const bv = toArray(shop.best_vibe);

    // ノイズ制御：最大8（没入型はタグ多すぎると雰囲気が死ぬ）
    const tags = [...tier, ...slot, ...bw, ...bv].filter(Boolean);
    return [...new Set(tags)].slice(0, 8);
  }

  function slideHtml(shop){
    const name = escapeHtml(shop.shop_name || shop.shop || "Untitled");
    const area = escapeHtml(shop.area_group || "");
    const detail = escapeHtml(shop.area_detail || "");
    const tags = buildTags(shop);

    // 画像は将来用：CSVに無いのでプレースホルダ
    // 将来 photo_url 等が入ればここで表示できる
    const hasImg = !!(shop.photo_url || shop.image_url || shop.image);
    const imgUrl = escapeHtml(shop.photo_url || shop.image_url || shop.image || "");

    return `
      <section class="slide" aria-label="result-slide">
        <div class="media">
          ${hasImg ? `<img src="${imgUrl}" alt="${name}" loading="lazy">` : ``}
        </div>

        <div class="pane">
          <div>
            <h2 class="name">${name}</h2>
            <p class="meta">${area}${detail ? " / " + detail : ""}</p>

            <div class="tags">
              ${tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("")}
            </div>
          </div>

          <div class="nav">
            <span class="hint">Take your time. This is curated for you.</span>
            <span class="hint" id="slideCounter"></span>
          </div>
        </div>
      </section>
    `;
  }

  function renderDots(){
    if(!dotbar) return;
    dotbar.innerHTML = shopsCache.map((_, i) =>
      `<span class="dot ${i===idx ? "active" : ""}"></span>`
    ).join("");
  }

  function render(){
    if(!shopsCache.length){
      deck.innerHTML = "";
      setError("No shops returned.");
      if(progressText) progressText.textContent = "0 / 0";
      if(dotbar) dotbar.innerHTML = "";
      return;
    }

    deck.innerHTML = slideHtml(shopsCache[idx]);
    const total = shopsCache.length;
    if(progressText) progressText.textContent = `${idx+1} / ${total}`;
    renderDots();

    const sc = document.getElementById("slideCounter");
    if(sc) sc.textContent = `${idx+1} / ${total}`;
  }

  function next(){ if(idx < shopsCache.length - 1){ idx++; render(); } }
  function prev(){ if(idx > 0){ idx--; render(); } }

  function getSessionId(){
    const u = new URL(location.href);
    return u.searchParams.get("session_id");
  }

  async function load(){
    clearError();
    setLoading();

    const sessionId = getSessionId();
    if(!sessionId){
      deck.innerHTML = "";
      setChips("—", "—", "—");
      setError("Missing session_id. Please retry checkout from hearing page.");
      return;
    }

    try{
      const res = await fetch(`/api/results?session_id=${encodeURIComponent(sessionId)}`);
      const data = await res.json().catch(()=> ({}));

      if(!res.ok || !data.ok){
        deck.innerHTML = "";
        setChips("—", "—", "—");
        setError(data.error || `Request failed (${res.status})`);
        return;
      }

      // chips
      const plan = data.plan || "—";
      const prefs = data.who ? data.who : "—";
      const areas = Array.isArray(data.shops)
        ? (data.shops.map(s=>s.area_group).filter(Boolean).slice(0,4).join(" / ") || "—")
        : "—";
      setChips(plan, prefs, areas);

      const shops = Array.isArray(data.shops) ? data.shops : [];
      if(shops.length === 0){
        deck.innerHTML = "";
        setError("No shops returned.");
        return;
      }

      shopsCache = shops;
      idx = 0;
      render();
    }catch(e){
      deck.innerHTML = "";
      setChips("—", "—", "—");
      setError("Network or server error. Check Vercel Runtime Logs.");
    }
  }

  // Buttons
  retryBtn.addEventListener("click", load);
  backBtn.addEventListener("click", () => {
    const u = new URL(location.href);
    const plan = (u.searchParams.get("plan") || "");
    location.href = `/hearing.html${plan ? "?plan="+encodeURIComponent(plan) : ""}`;
  });
  nextBtn.addEventListener("click", next);
  prevBtn.addEventListener("click", prev);

  // Keyboard
  window.addEventListener("keydown", (e) => {
    if(e.key === "ArrowRight") next();
    if(e.key === "ArrowLeft") prev();
  });

  // Swipe (mobile)
  let startX = null;
  deck.addEventListener("touchstart", (e) => {
    startX = e.touches?.[0]?.clientX ?? null;
  }, { passive:true });

  deck.addEventListener("touchend", (e) => {
    if(startX === null) return;
    const endX = e.changedTouches?.[0]?.clientX ?? startX;
    const dx = endX - startX;
    if(Math.abs(dx) > 40){
      if(dx < 0) next();
      else prev();
    }
    startX = null;
  }, { passive:true });

  load();
</script>
</body>
</html>
