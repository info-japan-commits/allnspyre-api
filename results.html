<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allnspyre | Results</title>
  <style>
    :root{--bg:#faf8f3;--card:#fff;--ink:#111;--muted:#6b6b6b;--line:#e8e2d9;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:32px 16px 56px}
    .topline{display:flex;justify-content:space-between;align-items:center;gap:10px;color:var(--muted);font-size:12px;margin-bottom:12px;flex-wrap:wrap}
    .h1{font-family:Georgia,"Times New Roman",serif;font-size:56px;line-height:1.0;margin:6px 0 8px}
    .sub{margin:0 0 18px;color:var(--muted)}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:18px 0}
    .btn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:650}
    .btnPrimary{border-color:#111}
    .state{
      border:1px solid var(--line);background:#fff;border-radius:14px;padding:12px 14px;color:var(--muted);
      margin:10px 0 18px;white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .card{border:1px solid var(--line);background:var(--card);border-radius:16px;padding:14px 14px}
    .title{font-family:Georgia,"Times New Roman",serif;font-size:22px;margin:0 0 6px}
    .meta{color:var(--muted);font-size:12px;margin:0 0 10px}
    .desc{margin:0;color:#222;line-height:1.55}
    .tagRow{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .tag{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);background:rgba(255,255,255,.6)}
    a{color:inherit}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topline">
      <div><b>PLAN:</b> <span id="plan">—</span></div>
      <div><b>AREAS:</b> <span id="areas">—</span></div>
      <div><b>Storage key:</b> allnspyre_hearing</div>
    </div>

    <div class="h1">Your 7 picks.</div>
    <p class="sub">Where locals actually eat — before the world finds out.</p>

    <div class="bar">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn btnPrimary" id="btnRetry">Retry</button>
        <button class="btn" id="btnBack">Back to Hearing</button>
      </div>
      <div style="color:var(--muted); font-size:12px" id="smallNote"></div>
    </div>

    <div class="state" id="state">Loading…</div>
    <div class="grid" id="grid"></div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "allnspyre_hearing";
  const API_BASE = location.origin; // https://allnspyre-api.vercel.app

  const elPlan = document.getElementById("plan");
  const elAreas = document.getElementById("areas");
  const elState = document.getElementById("state");
  const elGrid = document.getElementById("grid");
  const elNote = document.getElementById("smallNote");

  const btnRetry = document.getElementById("btnRetry");
  const btnBack  = document.getElementById("btnBack");

  function qsPlan() {
    const q = new URLSearchParams(location.search);
    return (q.get("plan") || "").toLowerCase();
  }

  function setState(msg, isError=false) {
    elState.style.borderColor = isError ? "#b00020" : "var(--line)";
    elState.textContent = msg;
  }

  function renderCards(records) {
    elGrid.innerHTML = "";
    records.forEach((r, idx) => {
      const c = document.createElement("div");
      c.className = "card";

      const t = document.createElement("div");
      t.className = "title";
      t.textContent = `${idx+1}. ${r.shop_name || r.name || "Untitled"}`;

      const m = document.createElement("div");
      m.className = "meta";
      const g = r.genre ? `Genre: ${r.genre}` : "";
      const a = r.area_group ? `Area: ${r.area_group}` : (r.area_detail ? `Area: ${r.area_detail}` : "");
      m.textContent = [g,a].filter(Boolean).join(" · ");

      const d = document.createElement("p");
      d.className = "desc";
      d.textContent = r.short_desc || r.desc || r.note || "";

      const tags = document.createElement("div");
      tags.className = "tagRow";
      if (r.area_detail) {
        const tg = document.createElement("span");
        tg.className = "tag";
        tg.textContent = r.area_detail;
        tags.appendChild(tg);
      }
      if (r.photo_status) {
        const tg = document.createElement("span");
        tg.className = "tag";
        tg.textContent = `photo: ${r.photo_status}`;
        tags.appendChild(tg);
      }

      c.appendChild(t);
      c.appendChild(m);
      c.appendChild(d);
      if (tags.childNodes.length) c.appendChild(tags);

      elGrid.appendChild(c);
    });
  }

  function loadPayload() {
    // ✅ ここが今回の確定修正：hearingData ではなく allnspyre_hearing を読む
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;

    try {
      const obj = JSON.parse(raw);
      // URLのplanがあればそれを優先（事故防止）
      const qp = qsPlan();
      if (qp) obj.plan = qp;
      return obj;
    } catch (e) {
      console.error(e);
      return null;
    }
  }

  async function fetchResults(payload) {
    const url = `${API_BASE}/api/results`;
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    const ct = (res.headers.get("content-type") || "");
    if (!res.ok) {
      const text = await res.text().catch(() => "");
      throw new Error(`API ${res.status} ${res.statusText}\n\n${text}`);
    }

    if (!ct.includes("application/json")) {
      const text = await res.text().catch(() => "");
      throw new Error(`API returned non-JSON.\n\n${text}`);
    }

    return await res.json();
  }

  async function run() {
    elGrid.innerHTML = "";

    const payload = loadPayload();
    if (!payload) {
      const qp = qsPlan() || "connoisseur";
      elPlan.textContent = qp;
      elAreas.textContent = "—";
      setState(
        "No hearing data found.\n\n" +
        "This usually means:\n" +
        "1) You opened results directly without completing hearing\n" +
        "2) localStorage was cleared\n\n" +
        "Fix: go back to hearing and select again.",
        true
      );
      return;
    }

    elPlan.textContent = payload.plan || "—";
    elAreas.textContent = (payload.areas && payload.areas.length) ? payload.areas.join(" / ") : "—";

    // 軽い検証（壊れてたら即止める）
    if (!payload.plan || !payload.prefs || !Array.isArray(payload.prefs) || payload.prefs.length === 0) {
      setState("Payload is missing required fields (plan/prefs).", true);
      return;
    }
    if (!payload.areas || !Array.isArray(payload.areas) || payload.areas.length === 0) {
      setState("Payload is missing required fields (areas).", true);
      return;
    }

    setState("Calling API…");
    elNote.textContent = `${API_BASE}/api/results`;

    try {
      const json = await fetchResults(payload);

      const records = json.records || json.items || [];
      if (!records.length) {
        setState("API returned no records.\n\n" + JSON.stringify(json, null, 2), true);
        return;
      }

      renderCards(records.slice(0, 7));
      setState(
        "OK ✅\n\n" +
        `records: ${records.length}\n` +
        (json.version ? `version: ${json.version}\n` : "") +
        "\n(You can now style the cards freely.)"
      );
    } catch (e) {
      console.error(e);
      setState("Failed ❌\n\n" + (e.message || String(e)), true);
    }
  }

  btnRetry.addEventListener("click", run);
  btnBack.addEventListener("click", () => {
    const p = qsPlan() || (loadPayload() && loadPayload().plan) || "connoisseur";
    location.href = `${API_BASE}/hearing.html?plan=${encodeURIComponent(p)}`;
  });

  run();
})();
</script>
</body>
</html>
