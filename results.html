<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allnspyre — Results</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#f6f7fb; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    .card { background: #fff; border: 1px solid #e7e9f2; border-radius: 16px; padding: 18px; box-shadow: 0 6px 18px rgba(20,30,60,.06); }
    .muted { color:#6b7280; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }
    .shop { background:#fff; border:1px solid #eceef7; border-radius: 14px; padding: 14px; }
    h1 { margin: 0 0 6px; font-size: 26px; }
    h2 { margin: 0 0 8px; font-size: 18px; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; background:#eef2ff; font-size: 12px; margin-right: 8px; }
    button { border: 1px solid #d6d9e6; background: #fff; padding: 10px 12px; border-radius: 12px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Your 7 Matches</h1>
      <div class="muted" id="subtitle">We’re generating your results…</div>
      <div style="margin-top:10px;">
        <button id="reloadBtn">Reload</button>
      </div>
    </div>

    <div class="grid" id="result"></div>
  </div>

  <script>
    const $result = document.getElementById("result");
    const $subtitle = document.getElementById("subtitle");
    document.getElementById("reloadBtn").addEventListener("click", () => location.reload());

    function getParam(name) {
      const params = new URLSearchParams(location.search);
      return params.get(name);
    }

    function splitList(str) {
      return String(str || "")
        .split(",")
        .map(s => decodeURIComponent(s).trim())
        .filter(Boolean);
    }

    async function loadResults() {
      // ✅ 正：areaDetails を読む（Airtableのarea_detailと同じ文字列）
      const areaDetailsRaw = getParam("areaDetails");

      // 互換：もし古いURLが areaIds を使ってても読めるようにする（ただしslugなら一致しない）
      const areaIdsRaw = getParam("areaIds");

      const plan = getParam("plan") || "";

      let areaDetails = splitList(areaDetailsRaw);
      if (areaDetails.length === 0 && areaIdsRaw) areaDetails = splitList(areaIdsRaw);

      if (areaDetails.length === 0) {
        $subtitle.textContent = "No area selected.";
        $result.innerHTML = "";
        return;
      }

      $subtitle.textContent =
        `Selected area: ${areaDetails.join(", ")} ${plan ? " / plan: " + plan : ""}`;

      try {
        const res = await fetch("/api/results", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            areaDetails,
            plan,
            who: null,
            mood: null,
            friction: null
          })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.ok) {
          $result.innerHTML = "";
          $subtitle.textContent = "Error loading results.";
          $result.innerHTML = `<div class="shop"><pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre></div>`;
          return;
        }

        if (!Array.isArray(data.shops) || data.shops.length === 0) {
          $result.innerHTML = "";
          $subtitle.textContent = "No shops returned.";
          return;
        }

        $subtitle.textContent = `Here are your ${data.shops.length} matches.`;

        $result.innerHTML = data.shops.map(shop => `
          <div class="shop">
            <h2>${escapeHtml(shop.shop_name || "Untitled")}</h2>
            <div class="muted">
              <span class="pill">${escapeHtml(shop.area_detail || "")}</span>
              <span class="pill">${escapeHtml(shop.genre || "")}</span>
            </div>
            <p style="margin:10px 0 0;">${escapeHtml(shop.short_desc || "")}</p>
          </div>
        `).join("");

      } catch (e) {
        $subtitle.textContent = "Error loading results.";
        $result.innerHTML = `<div class="shop"><pre>${escapeHtml(String(e))}</pre></div>`;
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    loadResults();
  </script>
</body>
</html>
