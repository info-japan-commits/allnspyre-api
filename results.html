<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allnspyre | Results</title>
  <style>
    :root{
      --bg:#f7f5f1;
      --card:#fff;
      --text:#111;
      --muted:#6b6b6b;
      --line:#e8e5df;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #fbfaf7 0%, var(--bg) 100%);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:28px 16px 72px}
    h1{
      font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;
      font-size:44px; line-height:1.05;
      margin:10px 0 8px;
      letter-spacing:-.02em;
    }
    .sub{color:var(--muted);margin:0 0 18px;font-size:15px}
    .pill{
      display:inline-block;
      font-size:12px;
      padding:7px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(255,255,255,.65);
      backdrop-filter: blur(6px);
      color:#222;
      margin-right:8px;
    }
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
      font-size:13px;
    }
    .grid{display:grid;grid-template-columns: 1fr 1fr;gap:14px;margin-top:18px}
    @media (max-width:840px){ .grid{grid-template-columns:1fr} h1{font-size:38px} }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.04);
    }
    .title{font-weight:750;font-size:18px;margin:0 0 8px}
    .meta{color:var(--muted);font-size:12px;margin:0 0 10px}
    .desc{margin:0;color:#222;line-height:1.55}
    .tagrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tag{border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px;color:#333;background:#fff}
    .state{
      margin-top:16px;
      padding:14px 14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.7);
      color:var(--muted);
      font-size:13px;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .danger{color:#c62828}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <span class="pill" id="planPill">PLAN: —</span>
        <span class="pill" id="areaPill">AREAS: —</span>
      </div>
      <div>
        <button class="btn" id="btnRetry">Retry</button>
        <button class="btn" id="btnBack">Back to Hearing</button>
      </div>
    </div>

    <h1>Your 7 picks.</h1>
    <p class="sub">Where locals actually eat — before the world finds out.</p>

    <div id="grid" class="grid"></div>

    <div id="stateBox" class="state">Loading…</div>
  </div>

<script>
(() => {
  // ✅ ここ固定：相対パス事故を潰す
  const API_BASE = "https://allnspyre-api.vercel.app";

  const grid = document.getElementById("grid");
  const stateBox = document.getElementById("stateBox");
  const planPill = document.getElementById("planPill");
  const areaPill = document.getElementById("areaPill");

  // hearingで保存したキー（この名前で統一）
  const STORAGE_KEY = "allnspyre_hearing";

  function setState(text, isError=false){
    stateBox.textContent = text;
    stateBox.className = "state" + (isError ? " danger" : "");
  }

  function safeJsonParse(s){
    try { return JSON.parse(s); } catch(e){ return null; }
  }

  function getPlanFromQuery(){
    const qs = new URLSearchParams(location.search);
    const p = (qs.get("plan") || "").toLowerCase();
    if (p === "connoisseur") return "connoisseur";
    return "explorer";
  }

  function getHearingPayload(){
    // ① URLにpayloadが載ってる場合（あれば優先）
    const qs = new URLSearchParams(location.search);
    const raw = qs.get("payload");
    if (raw) {
      const decoded = decodeURIComponent(raw);
      const parsed = safeJsonParse(decoded);
      if (parsed) return parsed;
    }

    // ② localStorage（通常はこれ）
    const s = localStorage.getItem(STORAGE_KEY);
    const parsed = safeJsonParse(s || "");
    if (parsed) return parsed;

    return null;
  }

  function renderCards(records){
    grid.innerHTML = "";
    records.forEach((r, idx) => {
      const fields = r.fields || r;

      const name = fields.shop_name || fields.name || `Pick ${idx+1}`;
      const short = fields.short_desc || fields.why_picked || fields.note || "";
      const genre = fields.genre || "";
      const area = fields.area_detail || fields.area_group || "";

      const card = document.createElement("div");
      card.className = "card";

      const h = document.createElement("div");
      h.className = "title";
      h.textContent = name;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = [area, genre].filter(Boolean).join(" • ");

      const desc = document.createElement("p");
      desc.className = "desc";
      desc.textContent = short;

      const tagrow = document.createElement("div");
      tagrow.className = "tagrow";

      // Allnspyreらしい軽いタグ
      const tags = [];
      if (fields.time_slot) tags.push(fields.time_slot);
      if (Array.isArray(fields.best_with) && fields.best_with.length) tags.push(fields.best_with[0]);
      if (Array.isArray(fields.best_vibe) && fields.best_vibe.length) tags.push(fields.best_vibe[0]);

      tags.slice(0,3).forEach(t => {
        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = t;
        tagrow.appendChild(tag);
      });

      card.appendChild(h);
      card.appendChild(meta);
      if (short) card.appendChild(desc);
      if (tags.length) card.appendChild(tagrow);

      grid.appendChild(card);
    });
  }

  async function fetchResults(payload){
    // planはURLのplan優先（保険）
    const urlPlan = getPlanFromQuery();
    payload.plan = payload.plan || urlPlan || "explorer";

    // APIへ渡す形（area_groupでOK。サーバー側で変換/抽出）
    const body = {
      plan: payload.plan,
      prefs: payload.prefs || [],
      areas: payload.areas || [],      // area_group
      who: payload.who || null,
      moods: payload.moods || [],
      frictions: payload.frictions || payload.avoid || [],
    };

    setState("Calling /api/results …\n" + JSON.stringify(body, null, 2));

    const res = await fetch(`${API_BASE}/api/results`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body),
    });

    const json = await res.json().catch(()=>null);

    if (!res.ok || !json) {
      throw new Error("API error (non-JSON or non-200)");
    }
    if (json.ok === false) {
      throw new Error(json.error || "API returned ok:false");
    }

    // records: Airtable風でもOK、配列でもOK
    const records = Array.isArray(json.records) ? json.records
                   : Array.isArray(json.data) ? json.data
                   : Array.isArray(json.shops) ? json.shops
                   : [];

    return { json, records };
  }

  function updateTop(payload){
    const plan = (payload?.plan || getPlanFromQuery() || "explorer").toUpperCase();
    planPill.textContent = `PLAN: ${plan}`;

    const areas = Array.isArray(payload?.areas) ? payload.areas : [];
    areaPill.textContent = `AREAS: ${areas.length ? areas.join(" / ") : "—"}`;
  }

  async function run(){
    grid.innerHTML = "";
    const payload = getHearingPayload();

    if (!payload) {
      setState(
        "No hearing data found.\n\n" +
        "This usually means:\n" +
        "1) You opened results directly without completing hearing\n" +
        "2) localStorage was cleared\n\n" +
        "Fix: go back to hearing and select again.",
        true
      );
      updateTop({ plan: getPlanFromQuery(), areas: [] });
      return;
    }

    updateTop(payload);

    try {
      const { json, records } = await fetchResults(payload);

      if (!records.length) {
        setState("API returned no records.\n\n" + JSON.stringify(json, null, 2), true);
        return;
      }

      renderCards(records);

      setState(
        "OK ✅\n\n" +
        "records: " + records.length + "\n" +
        (json.version ? ("version: " + json.version + "\n") : "") +
        "\n(You can now style the cards freely.)"
      );

    } catch (e) {
      setState("Failed ❌\n\n" + (e?.message || String(e)), true);
    }
  }

  document.getElementById("btnRetry").addEventListener("click", run);

  document.getElementById("btnBack").addEventListener("click", () => {
    // hearingページの場所が違うならここだけ変えてOK
    const plan = getPlanFromQuery();
    location.href = `${API_BASE}/hearing.html?plan=${plan}`;
  });

  run();
})();
</script>
</body>
</html>
