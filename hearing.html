<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tell me your vibe</title>
  <style>
    :root{
      --bg:#fafafa; --card:#ffffff; --text:#111; --muted:#666; --border:#e9e9e9;
      --shadow:0 8px 22px rgba(0,0,0,.06);
      --radius:16px;
    }
    body{
      margin:0; font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{ max-width:980px; margin:0 auto; padding:48px 20px 80px; }
    h1{ font-size:44px; line-height:1.1; margin:0 0 6px; }
    .sub{ color:var(--muted); margin:0 0 28px; }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:22px; margin:16px 0;
    }
    .stepTitle{ font-weight:700; display:flex; gap:12px; align-items:baseline; }
    .stepNum{ width:24px; color:#111; opacity:.9; }
    .stepHead{ font-size:18px; }
    .stepDesc{ color:var(--muted); margin:6px 0 14px; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:760px){ .grid2{ grid-template-columns:1fr; } h1{font-size:34px;} }

    .pill{
      border:1px solid var(--border); border-radius:14px; padding:12px 14px;
      background:#fff; cursor:pointer; user-select:none;
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      transition:.12s ease;
    }
    .pill:hover{ transform: translateY(-1px); }
    .pill.selected{
      border-color:#111; box-shadow:0 0 0 2px rgba(0,0,0,.06) inset;
    }
    .note{ color:var(--muted); font-size:12px; margin-top:8px; }
    .err{ color:#b00020; font-size:13px; margin-top:8px; white-space:pre-wrap; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;}
    .plan{ color:var(--muted); font-size:12px; letter-spacing:.12em; text-transform:uppercase; }

    .btn{
      margin-top:16px;
      width:100%;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid #111;
      background:#111;
      color:#fff;
      font-weight:700;
      cursor:pointer;
      transition:.12s ease;
    }
    .btn:disabled{ opacity:.35; cursor:not-allowed; }
    .btn.secondary{ background:#fff; color:#111; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .row .pill{ flex:1 1 160px; }
    .tiny{ font-size:12px; color:var(--muted); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Tell me your vibe.</h1>
        <p class="sub">A few quick choices — then we’ll take you to checkout.</p>
      </div>
      <div class="plan" id="planLabel">PLAN: —</div>
    </div>

    <!-- STEP 1 -->
    <div class="card">
      <div class="stepTitle">
        <div class="stepNum">1</div>
        <div>
          <div class="stepHead">Where</div>
          <div class="stepDesc">Which prefecture are you visiting?</div>
        </div>
      </div>

      <div class="grid2" id="prefGrid"></div>

      <div class="note" style="margin-top:14px;">
        Now choose your area. <span id="areaRule">(Single select)</span>
      </div>

      <div class="grid2" id="areaGrid" style="margin-top:10px;"></div>
      <div class="err" id="areaErr"></div>
      <div class="tiny" id="areaHint"></div>
    </div>

    <!-- STEP 2 -->
    <div class="card">
      <div class="stepTitle">
        <div class="stepNum">2</div>
        <div>
          <div class="stepHead">Who</div>
          <div class="stepDesc">Who are you eating with?</div>
        </div>
      </div>
      <div class="row" id="whoRow"></div>
    </div>

    <!-- STEP 3 -->
    <div class="card">
      <div class="stepTitle">
        <div class="stepNum">3</div>
        <div>
          <div class="stepHead">Time &amp; Mood</div>
          <div class="stepDesc">What kind of time do you want? <b>Choose up to 2.</b></div>
        </div>
      </div>
      <div class="grid2" id="moodGrid"></div>
    </div>

    <!-- STEP 4 -->
    <div class="card">
      <div class="stepTitle">
        <div class="stepNum">4</div>
        <div>
          <div class="stepHead">Friction control</div>
          <div class="stepDesc">Prefer to avoid? <span style="color:var(--muted)">(Optional)</span></div>
        </div>
      </div>
      <div class="grid2" id="avoidGrid"></div>
    </div>

    <!-- STEP 5 -->
    <div class="card">
      <div class="stepTitle">
        <div class="stepNum">5</div>
        <div>
          <div class="stepHead">No preference</div>
          <div class="stepDesc">If you’re not sure:</div>
        </div>
      </div>
      <div class="row" id="noprefRow"></div>

      <button class="btn" id="continueBtn" disabled>Continue →</button>
      <button class="btn secondary" id="debugBtn" type="button">Debug (show selections)</button>
      <div class="err" id="debugOut"></div>
    </div>
  </div>

<script>
  const PREFS = ["Tokyo","Kanagawa","Osaka","Kyoto","Hyogo","Nara","Fukuoka","Ishikawa"];
  const WHO = ["Solo","Partner","Friends","Family"];
  const MOODS = ["Quiet & reflective","Slow & indulgent","Deeply local","Lively & social"];
  const AVOIDS = ["Long lines","Tourist-heavy places","Very noisy spots"];

  const qs = new URLSearchParams(location.search);
  const plan = (qs.get("plan") || "explorer").toLowerCase();

  // ✅ Explorer=1 / Connoisseur=4
  const MAX_AREAS = plan === "connoisseur" ? 4 : 1;

  document.getElementById("planLabel").textContent = "PLAN: " + plan.toUpperCase();
  document.getElementById("areaRule").textContent = MAX_AREAS === 1 ? "(Single select)" : `(Up to ${MAX_AREAS})`;

  const state = { pref:null, areas:[], who:null, moods:[], avoids:[], noPref:false };

  const prefGrid = document.getElementById("prefGrid");
  const areaGrid = document.getElementById("areaGrid");
  const areaErr = document.getElementById("areaErr");
  const areaHint = document.getElementById("areaHint");
  const continueBtn = document.getElementById("continueBtn");
  const debugOut = document.getElementById("debugOut");

  function clearChildren(node){ while(node.firstChild) node.removeChild(node.firstChild); }
  function setSelected(el, yes){ el.classList.toggle("selected", !!yes); }
  function setErr(msg){ areaErr.textContent = msg || ""; }
  function setHint(msg){ areaHint.textContent = msg || ""; }

  function updateContinue(){
    const okAreas = state.noPref || state.areas.length >= 1;
    const ok = !!state.pref && okAreas && !!state.who && state.moods.length >= 1;
    continueBtn.disabled = !ok;
  }

  // ✅ pref選び直し可能にする：選んだ瞬間に area/err を全クリアして再ロード
  function resetAreasForNewPref(){
    state.areas = [];
    state.noPref = false;
    setErr("");
    setHint("");
    clearChildren(areaGrid);
    updateContinue();
  }

  async function loadAreas(pref){
    resetAreasForNewPref();
    if(!pref) return;
    setHint("Loading areas…");

    try{
      const r = await fetch(`/api/areas?pref=${encodeURIComponent(pref)}`, { cache:"no-store" });
      const data = await r.json();

      if(!r.ok || !data || data.ok !== true){
        setHint("");
        setErr("Failed to load areas.\n" + (data?.error || "Airtable request failed"));
        return;
      }

      const areas = Array.isArray(data.areaDetails) ? data.areaDetails : (Array.isArray(data.areas) ? data.areas : []);
      if(!areas.length){
        setHint("");
        setErr("No areas found for this prefecture.");
        return;
      }

      setHint(MAX_AREAS === 1
        ? "Pick one area — focused and fast."
        : `Pick up to ${MAX_AREAS} areas — we’ll build a richer route.`);

      areas.forEach(a => {
        const pill = document.createElement("div");
        pill.className = "pill";
        pill.innerHTML = `<div>${a}</div>`;

        pill.addEventListener("click", () => {
          // toggle behavior
          const idx = state.areas.indexOf(a);

          // if No preference was selected, disable it once user starts choosing
          state.noPref = false;

          if(idx >= 0){
            state.areas.splice(idx,1);
          }else{
            if(state.areas.length >= MAX_AREAS){
              // if explorer: replace, if connoisseur: block
              if(MAX_AREAS === 1){
                state.areas = [a];
              }else{
                setErr(`You can choose up to ${MAX_AREAS} areas.`);
                return;
              }
            }else{
              state.areas.push(a);
            }
          }

          // refresh selection UI
          [...areaGrid.children].forEach(child=>{
            const label = child.textContent.trim();
            setSelected(child, state.areas.includes(label));
          });

          setErr("");
          updateContinue();
        });

        areaGrid.appendChild(pill);
      });

    }catch(e){
      setHint("");
      setErr("Failed to load areas.\n" + String(e?.message || e));
    }
  }

  // --- render Step 1 Pref ---
  PREFS.forEach(p => {
    const pill = document.createElement("div");
    pill.className = "pill";
    pill.innerHTML = `<div>${p}</div>`;

    pill.addEventListener("click", async () => {
      state.pref = p;

      // update pref UI
      [...prefGrid.children].forEach(child=>{
        const label = child.textContent.trim();
        setSelected(child, label === p);
      });

      await loadAreas(p);
      updateContinue();
    });

    prefGrid.appendChild(pill);
  });

  // --- Step 2 Who ---
  const whoRow = document.getElementById("whoRow");
  WHO.forEach(w=>{
    const pill = document.createElement("div");
    pill.className = "pill";
    pill.innerHTML = `<div>${w}</div>`;
    pill.addEventListener("click", ()=>{
      state.who = w;
      [...whoRow.children].forEach(child=>{
        setSelected(child, child.textContent.trim() === w);
      });
      updateContinue();
    });
    whoRow.appendChild(pill);
  });

  // --- Step 3 Moods (up to 2) ---
  const moodGrid = document.getElementById("moodGrid");
  MOODS.forEach(m=>{
    const pill = document.createElement("div");
    pill.className = "pill";
    pill.innerHTML = `<div>${m}</div>`;
    pill.addEventListener("click", ()=>{
      const idx = state.moods.indexOf(m);
      if(idx >= 0){
        state.moods.splice(idx,1);
      }else{
        if(state.moods.length >= 2) return;
        state.moods.push(m);
      }
      [...moodGrid.children].forEach(child=>{
        setSelected(child, state.moods.includes(child.textContent.trim()));
      });
      updateContinue();
    });
    moodGrid.appendChild(pill);
  });

  // --- Step 4 Avoids (multi) ---
  const avoidGrid = document.getElementById("avoidGrid");
  AVOIDS.forEach(a=>{
    const pill = document.createElement("div");
    pill.className = "pill";
    pill.innerHTML = `<div>${a}</div>`;
    pill.addEventListener("click", ()=>{
      const idx = state.avoids.indexOf(a);
      if(idx >= 0) state.avoids.splice(idx,1);
      else state.avoids.push(a);
      [...avoidGrid.children].forEach(child=>{
        setSelected(child, state.avoids.includes(child.textContent.trim()));
      });
      updateContinue();
    });
    avoidGrid.appendChild(pill);
  });

  // --- Step 5 No preference ---
  const noprefRow = document.getElementById("noprefRow");
  const nop = document.createElement("div");
  nop.className = "pill";
  nop.innerHTML = `<div>No preference — pick for me</div>`;
  nop.addEventListener("click", ()=>{
    state.noPref = !state.noPref;
    if(state.noPref){
      state.areas = [];
      // clear area UI selections
      [...areaGrid.children].forEach(child => setSelected(child,false));
      setErr("");
    }
    setSelected(nop, state.noPref);
    updateContinue();
  });
  noprefRow.appendChild(nop);

  // --- continue ---
  continueBtn.addEventListener("click", ()=>{
    // 次は checkout（Stripe payment link）へ飛ばす想定
    // ここは今の運用に合わせて URL を差し替えてOK
    // 例: /pay.html?plan=...&pref=...&areas=...&who=...&moods=...&avoids=...
    const params = new URLSearchParams();
    params.set("plan", plan);
    params.set("pref", state.pref || "");
    params.set("areas", state.areas.join("|"));
    params.set("who", state.who || "");
    params.set("moods", state.moods.join("|"));
    params.set("avoids", state.avoids.join("|"));
    params.set("nopref", state.noPref ? "1" : "0");

    location.href = `/pay.html?${params.toString()}`;
  });

  // debug
  document.getElementById("debugBtn").addEventListener("click", ()=>{
    debugOut.textContent = JSON.stringify(state, null, 2);
  });

  updateContinue();
</script>
</body>
</html>
