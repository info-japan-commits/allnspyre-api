<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allnspyre | Hearing</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f7f6f2; color:#111; margin:0; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 28px 18px 60px; }
    h1 { font-family: Georgia, "Times New Roman", serif; font-size: 40px; margin: 18px 0 10px; }
    .card { background:#fff; border:1px solid #e9e6dc; border-radius: 16px; padding: 18px; box-shadow: 0 6px 22px rgba(0,0,0,.05); margin-top: 14px;}
    label { display:block; font-weight:600; margin: 12px 0 6px; }
    select, input { width:100%; padding: 10px 12px; border:1px solid #ddd; border-radius: 10px; font-size: 16px; background:#fff; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 680px){ .row{ grid-template-columns:1fr; } }
    .areas { display:flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .chip { border:1px solid #ddd; border-radius:999px; padding:8px 10px; cursor:pointer; user-select:none; background:#fff; }
    .chip[data-on="1"] { border-color:#111; }
    .btn { margin-top: 14px; display:flex; gap:10px; flex-wrap:wrap; }
    button { padding: 12px 14px; border-radius: 12px; border:1px solid #111; background:#111; color:#fff; font-size: 16px; cursor:pointer; }
    button.secondary { background:#fff; color:#111; border-color:#ddd; }
    .hint { color:#666; font-size: 13px; margin-top: 8px; }
    .err { color:#b00020; margin-top: 10px; font-weight:600; }
    .topbar { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .pill { font-size: 12px; padding: 6px 10px; border-radius:999px; border:1px solid #e9e6dc; background:#fff; color:#555; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="pill">Domain: allnspyre-api.vercel.app</div>
      <div class="pill" id="modePill">Ready</div>
    </div>

    <h1>Tell me your vibe.</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>Plan</label>
          <select id="plan">
            <option value="explorer">Explorer</option>
            <option value="connoisseur">Connoisseur</option>
          </select>
        </div>
        <div>
          <label>Prefecture (multi, comma-separated)</label>
          <input id="prefs" placeholder="Tokyo, Osaka, Hyogo" />
        </div>
      </div>

      <label>Areas (area_group)</label>
      <div class="hint">※ここで選ぶのは <b>area_group</b>（Tokyo Urban / Tokyo Suburban など）</div>
      <div id="areas" class="areas"></div>

      <div class="row">
        <div>
          <label>Who</label>
          <select id="who">
            <option value="">—</option>
            <option value="solo">Solo</option>
            <option value="couple">Couple</option>
            <option value="friends">Friends</option>
            <option value="family">Family</option>
          </select>
        </div>
        <div>
          <label>Mood</label>
          <select id="mood">
            <option value="">—</option>
            <option value="quiet">Quiet</option>
            <option value="lively">Lively</option>
            <option value="classic">Classic</option>
            <option value="adventurous">Adventurous</option>
          </select>
        </div>
      </div>

      <label>Avoid (comma-separated)</label>
      <input id="avoid" placeholder="queue, spicy, seafood ..." />

      <div class="btn">
        <button id="continueBtn">Continue →</button>
        <button class="secondary" id="clearBtn" type="button">Clear</button>
      </div>

      <div id="err" class="err" style="display:none;"></div>
      <div class="hint">保存キーは <b>allnspyre_hearing</b> で固定。</div>
    </div>
  </div>

<script>
(() => {
  const API = location.origin;
  const KEY = "allnspyre_hearing";

  const el = (id) => document.getElementById(id);
  const planEl = el("plan");
  const prefsEl = el("prefs");
  const areasWrap = el("areas");
  const whoEl = el("who");
  const moodEl = el("mood");
  const avoidEl = el("avoid");
  const errEl = el("err");
  const modePill = el("modePill");

  let areaGroups = [];
  let selected = new Set();

  function showErr(msg){
    errEl.style.display = "block";
    errEl.textContent = msg;
  }
  function clearErr(){
    errEl.style.display = "none";
    errEl.textContent = "";
  }

  function parsePrefs(){
    return prefsEl.value.split(",").map(s => s.trim()).filter(Boolean);
  }

  function renderChips(){
    areasWrap.innerHTML = "";
    areaGroups.forEach(g => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = g;
      chip.dataset.on = selected.has(g) ? "1" : "0";
      chip.onclick = () => {
        if(selected.has(g)) selected.delete(g); else selected.add(g);
        chip.dataset.on = selected.has(g) ? "1" : "0";
      };
      areasWrap.appendChild(chip);
    });
  }

  async function loadAreas(){
    clearErr();
    modePill.textContent = "Loading areas...";
    const plan = planEl.value;
    const prefs = parsePrefs();
    if(prefs.length === 0){
      areaGroups = [];
      selected = new Set();
      renderChips();
      modePill.textContent = "Ready";
      return;
    }
    const url = new URL(API + "/api/areas");
    url.searchParams.set("plan", plan);
    url.searchParams.set("pref", prefs.join(","));
    const r = await fetch(url.toString());
    const j = await r.json();
    if(!j.ok){
      showErr(j.error || "Failed to load areas");
      modePill.textContent = "Error";
      return;
    }
    areaGroups = j.areaGroups || [];
    // 初期選択：全部ON（社長の運用が楽）
    selected = new Set(areaGroups);
    renderChips();
    modePill.textContent = "Ready";
  }

  function save(){
    const payload = {
      plan: planEl.value,
      prefs: parsePrefs(),
      areaGroups: Array.from(selected),
      who: whoEl.value || "",
      mood: moodEl.value || "",
      avoid: avoidEl.value || "",
      ts: Date.now()
    };
    localStorage.setItem(KEY, JSON.stringify(payload));
    return payload;
  }

  // --- events
  planEl.addEventListener("change", loadAreas);
  prefsEl.addEventListener("change", loadAreas);
  prefsEl.addEventListener("blur", loadAreas);

  el("clearBtn").addEventListener("click", () => {
    localStorage.removeItem(KEY);
    prefsEl.value = "";
    selected = new Set();
    areaGroups = [];
    renderChips();
    clearErr();
  });

  el("continueBtn").addEventListener("click", () => {
    clearErr();
    const data = save();
    if(!data.prefs.length) return showErr("Prefecture is required (e.g., Tokyo)");
    if(!data.areaGroups.length) return showErr("Select at least 1 area_group");
    // ここで “Stripeへの遷移” をやる（planで分岐）
    // ※ 実運用は Studio 側のSTARTをStripeに飛ばすでもOKだが、今は hearing→Stripe を完成させる
    const stripeExplorer = "https://buy.stripe.com/3cI14f9Axa0mbcc89NbEA01";
    const stripeConnoisseur = "https://buy.stripe.com/7sY8wH7spc8u8001LpbEA02";
    const target = (data.plan === "connoisseur") ? stripeConnoisseur : stripeExplorer;
    location.href = target;
  });

  // restore saved
  try {
    const prev = JSON.parse(localStorage.getItem(KEY) || "null");
    if(prev){
      planEl.value = prev.plan || "explorer";
      prefsEl.value = (prev.prefs || []).join(", ");
      whoEl.value = prev.who || "";
      moodEl.value = prev.mood || "";
      avoidEl.value = prev.avoid || "";
    }
  } catch {}

  loadAreas().catch(e => showErr(String(e)));

})();
</script>
</body>
</html>
