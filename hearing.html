<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allnspyre | Hearing</title>
  <style>
    :root{
      --bg:#f7f5f1; --card:#ffffff; --text:#111; --muted:#6b6b6b;
      --line:#e8e5df; --danger:#c62828; --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: linear-gradient(180deg, #fbfaf7 0%, var(--bg) 100%);
    }
    .wrap{max-width:920px;margin:0 auto;padding:28px 18px 120px;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;margin-top:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.04);
    }
    .h{font-size:18px;font-weight:600;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .opt{
      border:1px solid var(--line);
      border-radius:12px;padding:12px;
      cursor:pointer;background:#fff;
    }
    .opt[aria-pressed="true"]{
      border-color:#111; box-shadow:inset 0 0 0 1px #111;
    }
    .footer{
      position:fixed;left:0;right:0;bottom:0;
      background:#fff;border-top:1px solid var(--line);
      padding:16px;text-align:center;
    }
    button.primary{
      background:#111;color:#fff;
      border:none;border-radius:999px;
      padding:12px 22px;font-weight:600;
      cursor:pointer;
    }
    button.primary:disabled{opacity:.4}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="card">
      <div class="h">Choose Plan</div>
      <div class="grid" id="planGrid">
        <button class="opt" data-plan="explorer">$19 Explorer</button>
        <button class="opt" data-plan="connoisseur">$39 Connoisseur</button>
      </div>
    </div>

    <div class="card">
      <div class="h">Who are you eating with?</div>
      <div class="grid" id="whoGrid">
        <button class="opt" data-who="solo">Solo</button>
        <button class="opt" data-who="partner">Partner</button>
        <button class="opt" data-who="friends">Friends</button>
        <button class="opt" data-who="family">Family</button>
      </div>
    </div>

    <div class="card">
      <div class="h">Vibe (choose 1)</div>
      <div class="grid" id="vibeGrid">
        <button class="opt" data-vibe="quiet_reflective">Quiet</button>
        <button class="opt" data-vibe="slow_indulgent">Slow</button>
        <button class="opt" data-vibe="deeply_local">Local</button>
        <button class="opt" data-vibe="lively_social">Lively</button>
      </div>
    </div>

  </div>

  <div class="footer">
    <button class="primary" id="continueBtn" disabled>
      Continue to payment
    </button>
  </div>

<script>
(() => {

  // ============================
  // ðŸ”¥ 100% GA client_id ç™ºè¡Œ
  // ============================
  function getOrCreateClientId(){
    const key = "aiinspyre_ga_cid";
    const saved = localStorage.getItem(key);
    if (saved) return saved;

    const cid = Date.now() + "." + Math.floor(Math.random()*1e9);
    localStorage.setItem(key, cid);
    return cid;
  }

  const state = {
    plan: null,
    who: null,
    vibe: null
  };

  const planGrid = document.getElementById("planGrid");
  const whoGrid = document.getElementById("whoGrid");
  const vibeGrid = document.getElementById("vibeGrid");
  const continueBtn = document.getElementById("continueBtn");

  function updateButton(){
    continueBtn.disabled = !(state.plan && state.who && state.vibe);
  }

  function toggleSelection(container, attr, key){
    container.querySelectorAll(".opt").forEach(btn=>{
      btn.setAttribute("aria-pressed","false");
    });
    event.target.setAttribute("aria-pressed","true");
    state[key] = event.target.dataset[attr];
    updateButton();
  }

  planGrid.addEventListener("click", (e)=>{
    if(!e.target.dataset.plan) return;
    toggleSelection(planGrid, "plan", "plan");
  });

  whoGrid.addEventListener("click", (e)=>{
    if(!e.target.dataset.who) return;
    toggleSelection(whoGrid, "who", "who");
  });

  vibeGrid.addEventListener("click", (e)=>{
    if(!e.target.dataset.vibe) return;
    toggleSelection(vibeGrid, "vibe", "vibe");
  });

  continueBtn.addEventListener("click", async () => {

    const ga_client_id = getOrCreateClientId();

    const payload = {
      plan: state.plan,
      who: state.who,
      vibes: state.vibe,
      ga_client_id
    };

    continueBtn.disabled = true;
    continueBtn.textContent = "Redirecting...";

    try{
      const res = await fetch("/api/checkout", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      const json = await res.json();
      location.href = json.url;
    }catch(e){
      alert("Checkout error");
      continueBtn.disabled = false;
      continueBtn.textContent = "Continue to payment";
    }
  });

})();
</script>

</body>
</html>
