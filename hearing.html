<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allnspyre | Hearing</title>
  <style>
    :root{
      --bg:#f7f6f2; --card:#fff; --ink:#111; --muted:#666;
      --line:#e9e6dc; --line2:#eee; --radius:18px;
    }
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:26px 18px 70px}
    h1{font-family:Georgia,"Times New Roman",serif;font-size:46px;margin:14px 0 8px}
    .sub{color:var(--muted);margin:0 0 14px;line-height:1.5}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:0 6px 22px rgba(0,0,0,.05);margin-top:14px}
    .top{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;gap:8px;align-items:center;font-size:12px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;color:#555}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:760px){.row{grid-template-columns:1fr}}
    label{display:block;font-weight:700;margin:12px 0 8px}
    select{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:12px;background:#fff;font-size:16px}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .tile{
      border:1px solid var(--line2);border-radius:16px;padding:12px 10px;
      cursor:pointer;user-select:none;background:#fff;transition:.08s;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .tile:hover{transform:translateY(-1px)}
    .tile[data-on="1"]{border-color:#111}
    .chiprow{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .chip{
      border:1px solid var(--line2);border-radius:999px;padding:10px 12px;
      background:#fff;cursor:pointer;user-select:none
    }
    .chip[data-on="1"]{border-color:#111}
    .hint{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.45}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    button{padding:12px 14px;border-radius:12px;border:1px solid #111;background:#111;color:#fff;font-size:16px;cursor:pointer}
    button.secondary{background:#fff;color:#111;border-color:#ddd}
    .err{margin-top:12px;border:1px solid #ffd2d2;background:#fff6f6;color:#b00020;border-radius:14px;padding:12px;display:none}
    .small{font-size:12px;color:#555}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="pill">Domain: allnspyre-api.vercel.app</div>
      <div class="pill" id="counterPill">Selected: 0</div>
    </div>

    <h1>Tell me your vibe.</h1>
    <p class="sub">No cuisine questions. Just <b>who</b> and <b>what kind of time</b>.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>Plan</label>
          <select id="plan">
            <option value="explorer">Explorer ($19)</option>
            <option value="connoisseur">Connoisseur ($39)</option>
          </select>
          <div class="hint">
            Explorer: pick <b>1 prefecture</b> → then <b>1 area_group</b><br>
            Connoisseur: pick up to <b>4 prefectures</b> → then up to <b>4 area_groups</b>
          </div>
        </div>

        <div>
          <label>Who are you eating with?</label>
          <select id="who">
            <option value="">—</option>
            <option value="Solo">Solo</option>
            <option value="Partner">Partner</option>
            <option value="Friends">Friends</option>
            <option value="Family">Family</option>
          </select>
        </div>
      </div>

      <label>STEP 1 — Prefecture</label>
      <div class="grid" id="prefGrid"></div>
      <div class="hint">You can change your mind anytime. (No lock-in.)</div>

      <label>STEP 1-B — Area group (only from selected prefectures)</label>
      <div class="chiprow" id="areaGroupRow"></div>
      <div class="hint" id="areasHint">Select prefecture(s) first.</div>

      <div class="row">
        <div>
          <label>Time & Mood (choose up to 2)</label>
          <select id="vibes" multiple size="4">
            <option>Quiet & reflective</option>
            <option>Slow & indulgent</option>
            <option>Deeply local</option>
            <option>Lively & social</option>
          </select>
          <div class="hint">Max 2 vibes.</div>
        </div>

        <div>
          <label>Prefer to avoid? (optional)</label>
          <select id="avoid" multiple size="3">
            <option>Long lines</option>
            <option>Tourist-heavy places</option>
            <option>Very noisy spots</option>
          </select>
          <div class="hint">These influence filtering quietly (not shown as “genres”).</div>
        </div>
      </div>

      <div class="actions">
        <button id="continueBtn">Continue → Stripe</button>
        <button class="secondary" id="clearBtn" type="button">Clear</button>
      </div>

      <div class="err" id="errBox"></div>
      <div class="hint">Saved key: <b>allnspyre_hearing</b> (fixed)</div>
      <div class="small" id="dbg"></div>
    </div>
  </div>

<script>
(() => {
  const KEY = "allnspyre_hearing";

  const PREFS = [
    "Tokyo","Kanagawa","Osaka","Kyoto","Hyogo","Nara","Fukuoka","Ishikawa"
  ];

  const stripeExplorer = "https://buy.stripe.com/3cI14f9Axa0mbcc89NbEA01";
  const stripeConnoisseur = "https://buy.stripe.com/7sY8wH7spc8u8001LpbEA02";

  const el = (id) => document.getElementById(id);
  const planEl = el("plan");
  const whoEl = el("who");
  const prefGrid = el("prefGrid");
  const areaRow = el("areaGroupRow");
  const vibesEl = el("vibes");
  const avoidEl = el("avoid");
  const errBox = el("errBox");
  const counterPill = el("counterPill");
  const areasHint = el("areasHint");
  const dbg = el("dbg");

  let prefSelected = new Set();
  let areaGroups = [];
  let areaSelected = new Set();

  function getPlan(){
    const q = (new URL(location.href)).searchParams.get("plan");
    const p = (q || planEl.value || "explorer").toLowerCase();
    return (p === "connoisseur") ? "connoisseur" : "explorer";
  }
  function maxPrefs(plan){ return plan === "connoisseur" ? 4 : 1; }
  function maxAreas(plan){ return plan === "connoisseur" ? 4 : 1; }

  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearErr(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  function selectedOptions(selectEl){
    return Array.from(selectEl.selectedOptions).map(o => o.value);
  }

  function save(){
    const plan = getPlan();
    const payload = {
      plan,
      prefs: Array.from(prefSelected),
      areaGroups: Array.from(areaSelected),
      who: whoEl.value || "",
      vibes: selectedOptions(vibesEl).slice(0,2),
      avoid: selectedOptions(avoidEl),
      ts: Date.now()
    };
    localStorage.setItem(KEY, JSON.stringify(payload));
    return payload;
  }

  function load(){
    try { return JSON.parse(localStorage.getItem(KEY) || "null"); }
    catch { return null; }
  }

  function setCounter(){
    const plan = getPlan();
    counterPill.textContent = `Prefs: ${prefSelected.size}/${maxPrefs(plan)}  |  Areas: ${areaSelected.size}/${maxAreas(plan)}`;
  }

  function renderPrefTiles(){
    prefGrid.innerHTML = "";
    const plan = getPlan();
    const mp = maxPrefs(plan);

    PREFS.forEach(p => {
      const tile = document.createElement("div");
      tile.className = "tile";
      tile.dataset.on = prefSelected.has(p) ? "1" : "0";
      tile.innerHTML = `<span>${p}</span><span class="small">${prefSelected.has(p) ? "✓" : ""}</span>`;
      tile.onclick = () => {
        clearErr();
        if (prefSelected.has(p)) {
          prefSelected.delete(p);
        } else {
          if (prefSelected.size >= mp) {
            showErr(plan === "connoisseur" ? "Connoisseur: up to 4 prefectures." : "Explorer: pick 1 prefecture.");
            return;
          }
          prefSelected.add(p);
        }
        // prefecture変更 → area選択を候補に合わせて掃除
        fetchAreasAndRender();
      };
      prefGrid.appendChild(tile);
    });
  }

  async function fetchAreas(plan, prefs){
    const url = new URL(location.origin + "/api/areas");
    url.searchParams.set("plan", plan);
    url.searchParams.set("pref", prefs.join(","));
    const r = await fetch(url.toString(), { method:"GET" });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || "Failed to load areas");
    return j.areaGroups || [];
  }

  function renderAreaChips(){
    areaRow.innerHTML = "";
    const plan = getPlan();
    const ma = maxAreas(plan);

    if (prefSelected.size === 0){
      areasHint.textContent = "Select prefecture(s) first.";
      setCounter();
      save();
      return;
    }

    if (!areaGroups.length){
      areasHint.textContent = "No area_group found for selected prefectures (check Airtable data/tier/status).";
      setCounter();
      save();
      return;
    }

    areasHint.textContent = (plan === "connoisseur")
      ? "Pick up to 4 area_groups."
      : "Pick 1 area_group.";

    areaGroups.forEach(g => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.dataset.on = areaSelected.has(g) ? "1" : "0";
      chip.textContent = g;
      chip.onclick = () => {
        clearErr();
        if (areaSelected.has(g)) {
          areaSelected.delete(g);
        } else {
          if (areaSelected.size >= ma) {
            showErr(plan === "connoisseur" ? "Connoisseur: up to 4 area_groups." : "Explorer: pick 1 area_group.");
            return;
          }
          areaSelected.add(g);
        }
        chip.dataset.on = areaSelected.has(g) ? "1" : "0";
        setCounter();
        save();
      };
      areaRow.appendChild(chip);
    });

    setCounter();
    save();
  }

  async function fetchAreasAndRender(){
    const plan = getPlan();
    renderPrefTiles(); // reflect selection

    // clear area selection if prefecture changed
    // keep only those still in candidate list after fetch
    try{
      setCounter();
      save();

      if (prefSelected.size === 0){
        areaGroups = [];
        areaSelected = new Set();
        renderAreaChips();
        return;
      }

      dbg.textContent = "Loading areas…";
      const prefs = Array.from(prefSelected);
      const groups = await fetchAreas(plan, prefs);
      areaGroups = groups;

      // clean selection to existing groups
      areaSelected = new Set(Array.from(areaSelected).filter(x => areaGroups.includes(x)));

      dbg.textContent = "";
      renderAreaChips();
    } catch(e){
      areaGroups = [];
      areaSelected = new Set();
      dbg.textContent = "";
      renderAreaChips();
      showErr(String(e.message || e));
    }
  }

  // enforce max 2 vibes
  vibesEl.addEventListener("change", () => {
    const chosen = selectedOptions(vibesEl);
    if (chosen.length > 2){
      // keep first 2
      Array.from(vibesEl.options).forEach(opt => opt.selected = chosen.slice(0,2).includes(opt.value));
      showErr("Time & Mood: up to 2.");
    } else {
      clearErr();
    }
    save(); setCounter();
  });
  avoidEl.addEventListener("change", () => { save(); setCounter(); });
  whoEl.addEventListener("change", () => { save(); setCounter(); });

  planEl.addEventListener("change", () => {
    clearErr();
    const plan = getPlan();
    // apply max limits when switching plan
    const mp = maxPrefs(plan);
    const ma = maxAreas(plan);

    prefSelected = new Set(Array.from(prefSelected).slice(0, mp));
    areaSelected = new Set(Array.from(areaSelected).slice(0, ma));
    fetchAreasAndRender();
  });

  el("clearBtn").addEventListener("click", () => {
    localStorage.removeItem(KEY);
    location.reload();
  });

  el("continueBtn").addEventListener("click", () => {
    clearErr();
    const data = save();
    const plan = getPlan();

    if (data.prefs.length === 0) return showErr("Pick prefecture(s).");
    if (data.areaGroups.length === 0) return showErr("Pick area_group(s).");

    if (plan === "explorer" && data.prefs.length !== 1) return showErr("Explorer: pick exactly 1 prefecture.");
    if (plan === "explorer" && data.areaGroups.length !== 1) return showErr("Explorer: pick exactly 1 area_group.");

    if (plan === "connoisseur" && data.prefs.length > 4) return showErr("Connoisseur: up to 4 prefectures.");
    if (plan === "connoisseur" && data.areaGroups.length > 4) return showErr("Connoisseur: up to 4 area_groups.");

    // hearing → Stripe（success_url は Stripe側で results.html に戻す）
    location.href = (plan === "connoisseur") ? stripeConnoisseur : stripeExplorer;
  });

  // restore state
  (function init(){
    const qPlan = (new URL(location.href)).searchParams.get("plan");
    if (qPlan) planEl.value = (qPlan.toLowerCase() === "connoisseur") ? "connoisseur" : "explorer";

    const prev = load();
    if (prev){
      // plan: URL優先
      if (!qPlan && prev.plan) planEl.value = (String(prev.plan).toLowerCase() === "connoisseur") ? "connoisseur" : "explorer";

      if (Array.isArray(prev.prefs)) prefSelected = new Set(prev.prefs.filter(x => PREFS.includes(x)));
      if (Array.isArray(prev.areaGroups)) areaSelected = new Set(prev.areaGroups);
      if (prev.who) whoEl.value = prev.who;

      if (Array.isArray(prev.vibes)){
        Array.from(vibesEl.options).forEach(opt => opt.selected = prev.vibes.includes(opt.value));
      }
      if (Array.isArray(prev.avoid)){
        Array.from(avoidEl.options).forEach(opt => opt.selected = prev.avoid.includes(opt.value));
      }
    }

    fetchAreasAndRender();
  })();

})();
</script>
</body>
</html>
