<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allnspyre | Hearing</title>
  <style>
    :root{
      --bg:#f7f5f1;
      --card:#ffffff;
      --text:#111;
      --muted:#6b6b6b;
      --line:#e8e5df;
      --accent:#111;
      --danger:#c62828;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: linear-gradient(180deg, #fbfaf7 0%, var(--bg) 100%);
    }
    .wrap{max-width:920px;margin:0 auto;padding:28px 18px 92px;}
    .top{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;margin-bottom:18px;}
    .brand{font-weight:650;letter-spacing:.2px}
    .sub{font-size:13px;color:var(--muted);margin-top:6px;line-height:1.35}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      border:1px solid var(--line);border-radius:999px;
      padding:8px 12px;font-size:13px;color:var(--muted);
      background:rgba(255,255,255,.6);backdrop-filter:blur(8px);white-space:nowrap;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:0 6px 18px rgba(0,0,0,.04);
      padding:18px;margin-top:14px;
    }
    .stepHead{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;margin-bottom:12px;}
    .kicker{font-size:12px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;}
    .h{font-size:18px;line-height:1.25;margin:6px 0 0;font-weight:650;}
    .note{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.5;}
    .danger{color:var(--danger);font-size:13px;margin-top:10px;display:none;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
    @media (min-width:760px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr));} }

    .opt{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      cursor:pointer;
      background:#fff;
      transition:transform .06s ease,border-color .06s ease;
      min-height:44px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .opt:hover{border-color:#d7d2c8;transform:translateY(-1px);}
    .opt[aria-pressed="true"]{border-color:#111;box-shadow:inset 0 0 0 1px #111;}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border:1px solid var(--line);
      border-radius:999px;font-size:12px;color:var(--muted);background:#fff;
    }
    .twoCol{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width:860px){
      .twoCol{grid-template-columns: 1fr 1.35fr;}
    }
    .panel{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:rgba(247,245,241,.55);
    }
    .panelTitle{font-weight:650;font-size:14px;margin:0 0 10px;}
    .small{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35;}
    .divider{height:1px;background:var(--line);margin:12px 0;}

    .footerBar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(255,255,255,.9);
      backdrop-filter:blur(10px);
      border-top:1px solid var(--line);
      padding:12px 16px;
    }
    .footerInner{
      max-width:920px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .primary{
      border:1px solid #111;background:#111;color:#fff;
      border-radius:999px;padding:12px 16px;cursor:pointer;
      font-size:14px;font-weight:650;
    }
    .primary:disabled{opacity:.45;cursor:not-allowed;}
    .spin{
      width:14px;height:14px;border:2px solid rgba(255,255,255,.35);
      border-top-color:#fff;border-radius:999px;display:inline-block;
      animation:sp 1s linear infinite;vertical-align:-2px;margin-right:8px;
    }
    @keyframes sp {to{transform:rotate(360deg)}}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="brand">Allnspyre | Hearing</div>
        <div class="sub">Fast, clean answers. We’ll do the thinking.</div>
      </div>
      <div class="pill"><span class="mono" id="planPill">plan: …</span></div>
    </div>

    <!-- STEP 0: PLAN -->
    <section class="card" id="step-plan">
      <div class="stepHead">
        <div>
          <div class="kicker">Step 0</div>
          <div class="h">Choose your plan</div>
        </div>
      </div>

      <div class="grid" id="planGrid">
        <button class="opt" type="button" data-plan="explorer" aria-pressed="false">
          <div><b>Explorer</b><br><small class="small">$19</small></div>
          <div>→</div>
        </button>
        <button class="opt" type="button" data-plan="connoisseur" aria-pressed="false">
          <div><b>Connoisseur</b><br><small class="small">$39</small></div>
          <div>→</div>
        </button>
      </div>

      <div class="note">
        Connoisseur: select up to <b>3 prefectures</b>. Then choose exactly <b>4 areas</b>.
      </div>
    </section>

    <!-- STEP 1: WHERE (NEW: one place multi-prefecture + 4 areas) -->
    <section class="card" id="step-where">
      <div class="stepHead">
        <div>
          <div class="kicker">Step 1</div>
          <div class="h">Where are you visiting?</div>
        </div>
        <div class="row">
          <span class="tag" id="prefLimitTag">Prefectures: 0/1</span>
          <span class="tag" id="areaLimitTag">Areas: 0/4</span>
        </div>
      </div>

      <div class="twoCol">
        <!-- Left: prefectures -->
        <div class="panel">
          <div class="panelTitle">Prefectures</div>
          <div class="grid" id="prefGrid"></div>
          <div class="small" id="prefHint"></div>
        </div>

        <!-- Right: areas -->
        <div class="panel">
          <div class="panelTitle">Areas (choose exactly 4)</div>
          <div class="small">These are <b>area_group</b> values from Airtable — no guessing.</div>
          <div class="divider"></div>
          <div id="areasWrap">
            <div class="small">Select prefectures to see available areas.</div>
          </div>
          <div class="danger" id="whereErr"></div>
        </div>
      </div>

      <div class="note">
        Tip: pick 4 areas that match your actual movement. You can edit anytime.
      </div>
    </section>

    <!-- STEP 2: WHO -->
    <section class="card" id="step-who" style="display:none">
      <div class="stepHead">
        <div>
          <div class="kicker">Step 2</div>
          <div class="h">Who are you eating with?</div>
        </div>
      </div>
      <div class="grid" id="whoGrid"></div>
    </section>

    <!-- STEP 3: VIBE -->
    <section class="card" id="step-vibe" style="display:none">
      <div class="stepHead">
        <div>
          <div class="kicker">Step 3</div>
          <div class="h">What kind of time do you want? <span class="small">(choose up to 2)</span></div>
        </div>
      </div>
      <div class="grid" id="vibeGrid"></div>
      <div class="danger" id="vibeErr"></div>
    </section>

    <!-- STEP 4: FRICTION -->
    <section class="card" id="step-friction" style="display:none">
      <div class="stepHead">
        <div>
          <div class="kicker">Step 4</div>
          <div class="h">Prefer to avoid? <span class="small">(optional)</span></div>
        </div>
      </div>
      <div class="grid" id="frictionGrid"></div>
    </section>

    <!-- STEP 5: NO PREFERENCE -->
    <section class="card" id="step-np" style="display:none">
      <div class="stepHead">
        <div>
          <div class="kicker">Step 5</div>
          <div class="h">If you’re not sure</div>
        </div>
      </div>
      <div class="grid" id="npGrid"></div>
    </section>
  </div>

  <div class="footerBar">
    <div class="footerInner">
      <div class="tag" id="readyTag">Not ready</div>
      <button class="primary" id="continueBtn" disabled>Continue to payment</button>
    </div>
  </div>

<script>
(() => {
  const PREFECTURES = ["Tokyo","Kanagawa","Osaka","Kyoto","Hyogo","Nara","Fukuoka","Ishikawa"];

  // Display label -> Airtable slug (best_with / best_vibe と一致させる：事故防止）
  const WHO = [
    { label:"Solo", slug:"solo" },
    { label:"Partner", slug:"partner" },
    { label:"Friends", slug:"friends" },
    { label:"Family", slug:"family" },
  ];

  const VIBES = [
    { label:"Quiet & reflective", slug:"quiet_reflective" },
    { label:"Slow & indulgent", slug:"slow_indulgent" },
    { label:"Deeply local", slug:"deeply_local" },
    { label:"Lively & social", slug:"lively_social" },
  ];

  const FRICTION = [
    { label:"Long lines", slug:"long_lines" },
    { label:"Tourist-heavy places", slug:"tourist_heavy" },
    { label:"Very noisy spots", slug:"very_noisy" },
  ];

  const NP = [{ label:"No preference — pick for me", slug:"no_preference" }];

  const qs = new URLSearchParams(location.search);
  const initialPlan = (qs.get("plan") || "explorer").toLowerCase();

  const state = {
    plan: (initialPlan === "connoisseur" ? "connoisseur" : "explorer"),
    prefectures: [],      // multi
    areasByPref: {},      // from API
    selectedAreas: [],    // area_group values (must be exactly 4)
    who: null,            // slug
    vibes: [],            // slugs (max 2)
    friction: [],         // slugs
    noPreference: false,
    loadingCheckout: false,
    loadingAreas: false,
  };

  // DOM
  const planPill = document.getElementById("planPill");
  const planGrid = document.getElementById("planGrid");

  const prefGrid = document.getElementById("prefGrid");
  const prefLimitTag = document.getElementById("prefLimitTag");
  const areaLimitTag = document.getElementById("areaLimitTag");
  const prefHint = document.getElementById("prefHint");
  const areasWrap = document.getElementById("areasWrap");
  const whereErr = document.getElementById("whereErr");

  const stepWho = document.getElementById("step-who");
  const whoGrid = document.getElementById("whoGrid");

  const stepVibe = document.getElementById("step-vibe");
  const vibeGrid = document.getElementById("vibeGrid");
  const vibeErr = document.getElementById("vibeErr");

  const stepFriction = document.getElementById("step-friction");
  const frictionGrid = document.getElementById("frictionGrid");

  const stepNp = document.getElementById("step-np");
  const npGrid = document.getElementById("npGrid");

  const continueBtn = document.getElementById("continueBtn");
  const readyTag = document.getElementById("readyTag");

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  function setPressed(container, selector, isOn){
    [...container.querySelectorAll(selector)].forEach(btn => {
      btn.setAttribute("aria-pressed", isOn(btn) ? "true" : "false");
    });
  }

  function setErr(el, msg){
    if (!msg){ el.style.display="none"; el.textContent=""; return; }
    el.textContent = msg;
    el.style.display="";
  }

  function updatePlanPill(){
    planPill.textContent = `plan: ${state.plan}`;
  }

  function maxPrefectures(){
    // Explorer: 1 / Connoisseur: 3 （社長の確定）
    return state.plan === "connoisseur" ? 3 : 1;
  }

  function updateLimitTags(){
    prefLimitTag.textContent = `Prefectures: ${state.prefectures.length}/${maxPrefectures()}`;
    areaLimitTag.textContent = `Areas: ${state.selectedAreas.length}/4`;
    prefHint.textContent = state.plan === "connoisseur"
      ? "Select up to 3 prefectures."
      : "Explorer selects 1 prefecture.";
  }

  async function fetchAreasMulti(prefs){
    const url = `/api/areas?prefectures=${encodeURIComponent(prefs.join(","))}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("Failed to fetch areas");
    return await res.json(); // {areasByPrefecture, areas}
  }

  function renderPlan(){
    updatePlanPill();
    setPressed(planGrid, ".opt[data-plan]", (btn) => btn.dataset.plan === state.plan);
  }

  function renderPrefGrid(){
    prefGrid.innerHTML = "";
    PREFECTURES.forEach(p => {
      const on = state.prefectures.includes(p);
      const btn = document.createElement("button");
      btn.className = "opt";
      btn.type = "button";
      btn.dataset.pref = p;
      btn.setAttribute("aria-pressed", on ? "true" : "false");
      btn.innerHTML = `<div><b>${escapeHtml(p)}</b></div><div>${on ? "✓" : "+"}</div>`;
      btn.onclick = async () => {
        setErr(whereErr, "");

        const onNow = state.prefectures.includes(p);
        if (onNow){
          // remove prefecture
          state.prefectures = state.prefectures.filter(x => x !== p);
        } else {
          // add prefecture (respect limit)
          if (state.prefectures.length >= maxPrefectures()){
            setErr(whereErr, `You can choose up to ${maxPrefectures()} prefecture(s) for this plan.`);
            return;
          }
          state.prefectures = [...state.prefectures, p];
        }

        // When prefectures change, clear selected areas (prevents stale mismatches)
        state.selectedAreas = [];
        state.areasByPref = {};

        renderWhere(); // immediate UI update

        if (state.prefectures.length === 0) return;

        // fetch areas for selected prefectures
        try{
          state.loadingAreas = true;
          renderWhere();
          const data = await fetchAreasMulti(state.prefectures);
          state.areasByPref = data.areasByPrefecture || {};
        }catch(e){
          setErr(whereErr, "Could not load areas. Please try again.");
        }finally{
          state.loadingAreas = false;
          renderWhere();
        }
      };
      prefGrid.appendChild(btn);
    });
  }

  function toggleArea(area){
    const has = state.selectedAreas.includes(area);
    if (has){
      state.selectedAreas = state.selectedAreas.filter(x => x !== area);
      return;
    }
    if (state.selectedAreas.length >= 4){
      setErr(whereErr, "You must choose exactly 4 areas (max 4).");
      return;
    }
    state.selectedAreas = [...state.selectedAreas, area];
  }

  function renderAreas(){
    areasWrap.innerHTML = "";

    if (state.prefectures.length === 0){
      areasWrap.innerHTML = `<div class="small">Select prefectures to see available areas.</div>`;
      return;
    }

    if (state.loadingAreas){
      areasWrap.innerHTML = `<div class="small">Loading areas…</div>`;
      return;
    }

    // Render grouped by prefecture (fast to scan)
    const prefs = [...state.prefectures];
    for (const p of prefs){
      const list = state.areasByPref?.[p] || [];
      const title = document.createElement("div");
      title.className = "kicker";
      title.style.marginTop = "6px";
      title.textContent = p.toUpperCase();
      areasWrap.appendChild(title);

      if (list.length === 0){
        const none = document.createElement("div");
        none.className = "small";
        none.textContent = "No areas found.";
        areasWrap.appendChild(none);
        continue;
      }

      const grid = document.createElement("div");
      grid.className = "grid";
      grid.style.marginTop = "8px";

      list.forEach(area => {
        const on = state.selectedAreas.includes(area);
        const btn = document.createElement("button");
        btn.className = "opt";
        btn.type = "button";
        btn.setAttribute("aria-pressed", on ? "true" : "false");
        btn.innerHTML = `<div><b>${escapeHtml(area)}</b></div><div>${on ? "✓" : "+"}</div>`;
        btn.onclick = () => {
          setErr(whereErr, "");
          toggleArea(area);
          renderWhere();
          // if exactly 4, reveal next step immediately
          if (state.selectedAreas.length === 4){
            stepWho.style.display = "";
            stepWho.scrollIntoView({behavior:"smooth", block:"start"});
          }
        };
        grid.appendChild(btn);
      });

      areasWrap.appendChild(grid);
    }

    const helper = document.createElement("div");
    helper.className = "small";
    helper.style.marginTop = "10px";
    helper.innerHTML = `Selected areas: <b>${escapeHtml(state.selectedAreas.length)}/4</b>`;
    areasWrap.appendChild(helper);
  }

  function renderWhere(){
    updateLimitTags();
    renderPrefGrid();
    renderAreas();

    // gating: must be exactly 4 areas
    if (state.selectedAreas.length === 4){
      stepWho.style.display = "";
    } else {
      stepWho.style.display = "none";
      stepVibe.style.display = "none";
      stepFriction.style.display = "none";
      stepNp.style.display = "none";
      state.who = null;
      state.vibes = [];
      state.friction = [];
      state.noPreference = false;
      setErr(vibeErr, "");
    }

    updateFooter();
  }

  function renderWho(){
    whoGrid.innerHTML = "";
    WHO.forEach(w => {
      const on = state.who === w.slug;
      const btn = document.createElement("button");
      btn.className = "opt";
      btn.type = "button";
      btn.setAttribute("aria-pressed", on ? "true" : "false");
      btn.innerHTML = `<div><b>${escapeHtml(w.label)}</b></div><div>→</div>`;
      btn.onclick = () => {
        state.who = w.slug;
        stepVibe.style.display = "";
        stepVibe.scrollIntoView({behavior:"smooth", block:"start"});
        renderAll(false);
      };
      whoGrid.appendChild(btn);
    });
  }

  function renderVibe(){
    vibeGrid.innerHTML = "";
    setErr(vibeErr, "");
    VIBES.forEach(v => {
      const on = state.vibes.includes(v.slug);
      const btn = document.createElement("button");
      btn.className = "opt";
      btn.type = "button";
      btn.setAttribute("aria-pressed", on ? "true" : "false");
      btn.innerHTML = `<div><b>${escapeHtml(v.label)}</b></div><div>${on ? "✓" : "+"}</div>`;
      btn.onclick = () => {
        const has = state.vibes.includes(v.slug);
        if (has){
          state.vibes = state.vibes.filter(x => x !== v.slug);
        } else {
          if (state.vibes.length >= 2){
            setErr(vibeErr, "You can choose up to 2.");
            return;
          }
          state.vibes = [...state.vibes, v.slug];
        }
        if (state.vibes.length > 0){
          stepFriction.style.display = "";
          stepNp.style.display = "";
        } else {
          stepFriction.style.display = "none";
          stepNp.style.display = "none";
          state.friction = [];
          state.noPreference = false;
        }
        renderAll(false);
      };
      vibeGrid.appendChild(btn);
    });
  }

  function renderFriction(){
    frictionGrid.innerHTML = "";
    FRICTION.forEach(f => {
      const on = state.friction.includes(f.slug);
      const btn = document.createElement("button");
      btn.className = "opt";
      btn.type = "button";
      btn.setAttribute("aria-pressed", on ? "true" : "false");
      btn.innerHTML = `<div><b>${escapeHtml(f.label)}</b></div><div>${on ? "✓" : "+"}</div>`;
      btn.onclick = () => {
        const has = state.friction.includes(f.slug);
        state.friction = has ? state.friction.filter(x => x !== f.slug) : [...state.friction, f.slug];
        renderAll(false);
      };
      frictionGrid.appendChild(btn);
    });
  }

  function renderNP(){
    npGrid.innerHTML = "";
    const on = state.noPreference;
    const btn = document.createElement("button");
    btn.className = "opt";
    btn.type = "button";
    btn.setAttribute("aria-pressed", on ? "true" : "false");
    btn.innerHTML = `<div><b>${escapeHtml(NP[0].label)}</b></div><div>${on ? "✓" : "+"}</div>`;
    btn.onclick = () => {
      state.noPreference = !state.noPreference;
      renderAll(false);
    };
    npGrid.appendChild(btn);
  }

  function canContinue(){
    if (state.selectedAreas.length !== 4) return false; // MUST be 4
    if (!state.who) return false;
    if (state.vibes.length === 0) return false;
    return true;
  }

  function updateFooter(){
    const ok = canContinue();
    readyTag.textContent = ok ? "Ready" : "Not ready";
    continueBtn.disabled = !ok || state.loadingCheckout;
    continueBtn.innerHTML = state.loadingCheckout ? `<span class="spin"></span>Redirecting…` : `Continue to payment`;
  }

  function renderAll(scroll=true){
    renderPlan();
    renderWhere();
    if (state.selectedAreas.length === 4){
      renderWho();
      if (state.who){
        stepVibe.style.display = "";
        renderVibe();
      } else {
        stepVibe.style.display = "none";
      }
      if (state.vibes.length > 0){
        stepFriction.style.display = "";
        stepNp.style.display = "";
        renderFriction();
        renderNP();
      } else {
        stepFriction.style.display = "none";
        stepNp.style.display = "none";
      }
    }
    updateFooter();
    if (scroll) document.getElementById("step-where").scrollIntoView({behavior:"smooth", block:"start"});
  }

  // Plan click
  planGrid.addEventListener("click", (e) => {
    const btn = e.target.closest(".opt[data-plan]");
    if (!btn) return;
    const p = btn.dataset.plan;
    if (p !== "explorer" && p !== "connoisseur") return;

    state.plan = p;
    // enforce prefecture limit immediately
    const limit = maxPrefectures();
    if (state.prefectures.length > limit) state.prefectures = state.prefectures.slice(0, limit);

    // reset dependent selections for safety
    state.selectedAreas = [];
    state.areasByPref = {};
    state.who = null;
    state.vibes = [];
    state.friction = [];
    state.noPreference = false;

    const u = new URL(location.href);
    u.searchParams.set("plan", state.plan);
    history.replaceState({}, "", u.toString());

    renderAll();
  });

  // Continue -> /api/checkout
  continueBtn.addEventListener("click", async () => {
    if (!canContinue() || state.loadingCheckout) return;
    state.loadingCheckout = true;
    updateFooter();

    const payload = {
      plan: state.plan,
      // IMPORTANT: send area_group values (Airtableと一致)
      area_groups: state.selectedAreas,
      who: state.who,           // slug (best_withと一致)
      vibes: state.vibes,       // slugs (best_vibeと一致)
      friction: state.friction, // slugs
      no_preference: state.noPreference,
      source: "hearing.html"
    };

    try{
      const res = await fetch("/api/checkout", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error("checkout failed");

      const json = await res.json();
      const checkoutUrl = json.url || json.checkout_url || json.checkoutUrl;
      if (!checkoutUrl) throw new Error("no url");
      location.href = checkoutUrl;
    }catch(e){
      // If checkout isn't ready yet, at least show a clear error
      alert("Checkout is not ready yet. Please set up /api/checkout first.");
    }finally{
      state.loadingCheckout = false;
      updateFooter();
    }
  });

  // Init
  renderAll(false);
})();
</script>
</body>
</html>
