<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tell me your vibe.</title>
  <style>
    :root{
      --bg:#f6f6f6; --card:#fff; --line:#e9e9e9; --text:#111; --muted:#777; --muted2:#999;
      --shadow:0 10px 24px rgba(0,0,0,.06); --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:42px 24px 64px;}
    h1{font-size:52px;line-height:1.04;margin:8px 0 10px;letter-spacing:-.03em;}
    .sub{color:var(--muted);font-size:16px;margin-bottom:22px;}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px;}
    .planBadge{font-size:12px;color:var(--muted2);text-transform:uppercase;letter-spacing:.08em;user-select:none;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin:18px 0;}
    .stepHead{display:flex;align-items:baseline;gap:12px;margin-bottom:14px;}
    .stepNo{font-weight:600;color:var(--muted2);width:18px;text-align:right;}
    .stepTitle{font-weight:650;font-size:18px;}
    .stepDesc{color:var(--muted);font-size:13px;margin-top:2px;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .choice{border:1px solid var(--line);border-radius:14px;padding:14px;cursor:pointer;user-select:none;background:#fff;transition:transform .08s ease,border-color .12s ease;}
    .choice:hover{transform:translateY(-1px);}
    .choice.selected{border-color:#111;box-shadow:0 0 0 1px #111 inset;}
    .choice.disabled{opacity:.45;cursor:not-allowed;transform:none;}
    .divider{height:1px;background:var(--line);margin:16px 0;}
    .row{display:flex;justify-content:space-between;align-items:center;gap:14px;margin-top:10px;}
    .hint{color:var(--muted);font-size:12px;}
    .error{color:#b11;font-size:12px;margin-top:8px;white-space:pre-wrap;}
    .btnRow{display:flex;justify-content:flex-end;gap:10px;margin-top:18px;}
    .btn{border-radius:999px;padding:12px 18px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;}
    .btn.primary{background:#111;color:#fff;border-color:#111;}
    .btn:disabled{opacity:.45;cursor:not-allowed;}
    @media (max-width:820px){h1{font-size:42px}.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Tell me your vibe.</h1>
        <div class="sub">A few quick choices — then we’ll take you to checkout.</div>
      </div>
      <div class="planBadge" id="planBadge">PLAN: —</div>
    </div>

    <!-- STEP 1 -->
    <div class="card">
      <div class="stepHead">
        <div class="stepNo">1</div>
        <div>
          <div class="stepTitle">Where</div>
          <div class="stepDesc">Which prefecture are you visiting?</div>
        </div>
      </div>

      <div class="grid2" id="prefGrid"></div>

      <div class="divider"></div>

      <div class="stepDesc" id="areaLabel">Now choose your area. (Single select)</div>
      <div class="grid2" id="areaGrid" style="margin-top:10px;"></div>
      <div class="row">
        <div class="hint" id="areaHint">Pick one area — focused and fast.</div>
        <div class="hint" id="areaCountHint"></div>
      </div>
      <div class="error" id="areaError" style="display:none;"></div>
    </div>

    <!-- STEP 2 -->
    <div class="card">
      <div class="stepHead">
        <div class="stepNo">2</div>
        <div>
          <div class="stepTitle">Who</div>
          <div class="stepDesc">Who are you eating with?</div>
        </div>
      </div>
      <div class="grid2" id="whoGrid"></div>
    </div>

    <!-- STEP 3 -->
    <div class="card">
      <div class="stepHead">
        <div class="stepNo">3</div>
        <div>
          <div class="stepTitle">Time &amp; Mood</div>
          <div class="stepDesc">What kind of time do you want? <b>Choose up to 2.</b></div>
        </div>
      </div>
      <div class="grid2" id="moodGrid"></div>
      <div class="row">
        <div class="hint">Two is perfect — a clean combination.</div>
        <div class="hint" id="moodCountHint"></div>
      </div>
    </div>

    <!-- STEP 4 -->
    <div class="card">
      <div class="stepHead">
        <div class="stepNo">4</div>
        <div>
          <div class="stepTitle">Friction control</div>
          <div class="stepDesc">Prefer to avoid? (Optional)</div>
        </div>
      </div>
      <div class="grid2" id="avoidGrid"></div>
    </div>

    <div class="btnRow">
      <button class="btn" id="resetBtn" type="button">Reset</button>
      <button class="btn primary" id="continueBtn" type="button" disabled>Continue to checkout →</button>
    </div>
  </div>

<script>
  // ---------- CONFIG ----------
  const PREFS = ["Tokyo","Kanagawa","Osaka","Kyoto","Hyogo","Nara","Fukuoka","Ishikawa"];
  const WHO = ["Solo","Partner","Friends","Family"];
  const MOODS = [
    {key:"quiet_reflective", label:"Quiet & reflective"},
    {key:"slow_indulgent",   label:"Slow & indulgent"},
    {key:"deeply_local",     label:"Deeply local"},
    {key:"lively_social",    label:"Lively & social"}
  ];
  const AVOIDS = [
    {key:"long_lines", label:"Long lines"},
    {key:"tourist_heavy", label:"Tourist-heavy places"},
    {key:"very_noisy", label:"Very noisy spots"}
  ];

  function getPlan(){
    const u = new URL(location.href);
    const p = (u.searchParams.get("plan") || "").toLowerCase().trim();
    if (p === "connoisseur") return "connoisseur";
    return "explorer";
  }
  function maxAreasForPlan(plan){ return plan === "connoisseur" ? 4 : 1; }

  const state = {
    plan: getPlan(),
    pref: "",
    areaGroups: [],      // selected area_group(s)
    who: "",
    moods: [],           // up to 2
    avoids: [],          // optional
    _areaGroupList: []   // loaded from API
  };

  const planBadge = document.getElementById("planBadge");
  const prefGrid = document.getElementById("prefGrid");
  const areaGrid = document.getElementById("areaGrid");
  const areaLabel = document.getElementById("areaLabel");
  const areaHint = document.getElementById("areaHint");
  const areaCountHint = document.getElementById("areaCountHint");
  const areaError = document.getElementById("areaError");

  const whoGrid = document.getElementById("whoGrid");
  const moodGrid = document.getElementById("moodGrid");
  const moodCountHint = document.getElementById("moodCountHint");
  const avoidGrid = document.getElementById("avoidGrid");

  const resetBtn = document.getElementById("resetBtn");
  const continueBtn = document.getElementById("continueBtn");

  function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }

  function mkChoice(label){
    const div = document.createElement("div");
    div.className = "choice";
    div.textContent = label;
    return div;
  }

  function setLabelByPlan(){
    const maxA = maxAreasForPlan(state.plan);
    planBadge.textContent = `PLAN: ${state.plan.toUpperCase()}`;

    if (maxA === 1){
      areaLabel.textContent = "Now choose your area. (Single select)";
      areaHint.textContent  = "Pick one broad area — focused and fast.";
    } else {
      areaLabel.textContent = "Now choose your area. (Up to 4)";
      areaHint.textContent  = "Pick up to 4 broad areas — we’ll build a richer route.";
    }
    areaCountHint.textContent = state.areaGroups.length ? `${state.areaGroups.length}/${maxA}` : "";
  }

  function validate(){
    const ok = Boolean(state.pref)
      && state.areaGroups.length >= 1
      && Boolean(state.who)
      && state.moods.length >= 1;
    continueBtn.disabled = !ok;
  }

  // ---------- PREFS ----------
  function renderPrefs(){
    clear(prefGrid);
    PREFS.forEach(p=>{
      const c = mkChoice(p);
      if (state.pref === p) c.classList.add("selected");
      c.onclick = async ()=>{
        if (state.pref !== p){
          // pref changed -> reset selected areaGroups
          state.pref = p;
          state.areaGroups = [];
          state._areaGroupList = [];
          areaError.style.display = "none";
          areaError.textContent = "";

          setLabelByPlan();
          renderPrefs();
          await loadAreaGroups();
          renderAreaGroups();
          validate();
        }
      };
      prefGrid.appendChild(c);
    });
  }

  // ---------- AREAS API ----------
  async function loadAreaGroups(){
    clear(areaGrid);
    areaError.style.display = "none";
    areaError.textContent = "";
    areaCountHint.textContent = "";

    if (!state.pref) return;

    try{
      const pref = encodeURIComponent(state.pref);
      const plan = encodeURIComponent(state.plan);
      const r = await fetch(`/api/areas?pref=${pref}&plan=${plan}`, { cache: "no-store" });
      const data = await r.json();

      if (!r.ok || !data || data.ok !== true){
        throw new Error((data && (data.error || data.details)) ? JSON.stringify(data) : "Failed to load areas.");
      }
      state._areaGroupList = Array.isArray(data.areaGroups) ? data.areaGroups : [];
    }catch(e){
      state._areaGroupList = [];
      areaError.style.display = "block";
      areaError.textContent = `Failed to load areas.\n${String(e.message || e)}`;
    }
  }

  // ---------- RENDER AREAS ----------
  function renderAreaGroups(){
    clear(areaGrid);
    const list = state._areaGroupList || [];
    const maxA = maxAreasForPlan(state.plan);

    areaCountHint.textContent = state.areaGroups.length ? `${state.areaGroups.length}/${maxA}` : "";

    if (!state.pref) return;

    if (!list.length){
      if (areaError.style.display !== "block"){
        areaError.style.display = "block";
        areaError.textContent = "No areas found for this prefecture.";
      }
      return;
    }

    list.forEach(g=>{
      const c = mkChoice(g);
      const selected = state.areaGroups.includes(g);
      if (selected) c.classList.add("selected");

      if (!selected && state.areaGroups.length >= maxA){
        c.classList.add("disabled");
      }

      c.onclick = ()=>{
        const has = state.areaGroups.includes(g);
        if (maxA === 1){
          state.areaGroups = [g];
        } else {
          if (has){
            state.areaGroups = state.areaGroups.filter(x=>x!==g);
          } else {
            if (state.areaGroups.length < maxA){
              state.areaGroups = [...state.areaGroups, g];
            }
          }
        }
        setLabelByPlan();
        renderAreaGroups();
        validate();
      };

      areaGrid.appendChild(c);
    });
  }

  // ---------- WHO ----------
  function renderWho(){
    clear(whoGrid);
    WHO.forEach(w=>{
      const c = mkChoice(w);
      if (state.who === w) c.classList.add("selected");
      c.onclick = ()=>{
        state.who = w;
        renderWho();
        validate();
      };
      whoGrid.appendChild(c);
    });
  }

  // ---------- MOODS (max 2) ----------
  function renderMoods(){
    clear(moodGrid);
    moodCountHint.textContent = state.moods.length ? `${state.moods.length}/2` : "";

    MOODS.forEach(m=>{
      const c = mkChoice(m.label);
      const sel = state.moods.includes(m.key);
      if (sel) c.classList.add("selected");
      if (!sel && state.moods.length >= 2) c.classList.add("disabled");

      c.onclick = ()=>{
        const has = state.moods.includes(m.key);
        if (has){
          state.moods = state.moods.filter(x=>x!==m.key);
        } else {
          if (state.moods.length < 2) state.moods = [...state.moods, m.key];
        }
        renderMoods();
        validate();
      };

      moodGrid.appendChild(c);
    });
  }

  // ---------- AVOIDS ----------
  function renderAvoids(){
    clear(avoidGrid);
    AVOIDS.forEach(a=>{
      const c = mkChoice(a.label);
      const sel = state.avoids.includes(a.key);
      if (sel) c.classList.add("selected");
      c.onclick = ()=>{
        if (sel){
          state.avoids = state.avoids.filter(x=>x!==a.key);
        } else {
          state.avoids = [...state.avoids, a.key];
        }
        renderAvoids();
      };
      avoidGrid.appendChild(c);
    });
  }

  // Continue -> pay.html (you already control where pay.html sends)
  function buildQuery(){
    const q = new URLSearchParams();
    q.set("plan", state.plan);
    q.set("pref", state.pref);
    // ✅ send area_group values (broad labels)
    q.set("areaGroups", state.areaGroups.join("|"));
    q.set("who", state.who.toLowerCase());
    q.set("moods", state.moods.join("|"));
    if (state.avoids.length) q.set("avoid", state.avoids.join("|"));
    return q.toString();
  }

  continueBtn.onclick = ()=>{
    location.href = `/pay.html?${buildQuery()}`;
  };

  function resetAll(){
    state.pref = "";
    state.areaGroups = [];
    state.who = "";
    state.moods = [];
    state.avoids = [];
    state._areaGroupList = [];
    areaError.style.display = "none";
    areaError.textContent = "";
    setLabelByPlan();
    renderPrefs();
    renderAreaGroups();
    renderWho();
    renderMoods();
    renderAvoids();
    validate();
  }

  resetBtn.onclick = resetAll;

  // ---------- INIT ----------
  (async function init(){
    state.plan = getPlan();
    setLabelByPlan();
    renderPrefs();
    renderWho();
    renderMoods();
    renderAvoids();
    validate();
  })();
</script>
</body>
</html>
