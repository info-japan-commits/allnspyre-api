<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allnspyre | Hearing</title>
  <style>
    :root{
      --bg:#f6f6f3;
      --card:#ffffffcc;
      --text:#0f0f0f;
      --muted:#6b6b6b;
      --line:#e8e8e2;
      --chip:#ffffff;
      --chipOn:#0f0f0f;
      --chipOnText:#fff;
      --danger:#c0392b;
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 70% 0%, #ffffff 0%, var(--bg) 65%);
    }
    .wrap{max-width:980px;margin:0 auto;padding:44px 16px 80px}
    h1{
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      font-size:46px; line-height:1.05; margin:0 0 10px;
      letter-spacing:-.02em;
    }
    .sub{color:var(--muted);margin:0 0 28px;font-size:15px}
    .pill{
      display:inline-block;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;color:var(--muted);
      background:#fff;
    }
    .toprow{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:22px;
      backdrop-filter: blur(6px);
    }
    .section{margin-top:16px}
    .secTitle{display:flex;align-items:baseline;gap:10px;margin:0 0 10px}
    .secTitle .n{font-weight:600}
    .secTitle .t{font-weight:700}
    .hint{color:var(--muted);font-size:13px;margin:0 0 14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){ .grid2{grid-template-columns:1fr} h1{font-size:40px} }
    .chip{
      width:100%;
      border:1px solid var(--line);
      background:var(--chip);
      padding:14px 14px;
      border-radius:14px;
      text-align:left;
      font-size:16px;
      cursor:pointer;
      transition: .12s ease;
      color:var(--text);
    }
    .chip:hover{transform: translateY(-1px)}
    .chip.on{
      border-color:#0f0f0f;
      box-shadow: 0 0 0 1px #0f0f0f inset;
    }
    .chip.onStrong{
      background:var(--chipOn);
      color:var(--chipOnText);
      border-color:var(--chipOn);
      box-shadow:none;
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:10px}
    .counter{color:var(--muted);font-size:12px}
    .divider{height:1px;background:var(--line);margin:18px 0}
    .error{color:var(--danger);font-size:13px;margin-top:8px}
    .ok{color:#2e7d32;font-size:13px;margin-top:8px}
    .footerBar{
      position: sticky;
      bottom: 0;
      margin-top: 22px;
      padding-top: 14px;
      background: linear-gradient(to top, rgba(246,246,243,.98), rgba(246,246,243,.75), rgba(246,246,243,0));
      backdrop-filter: blur(6px);
    }
    .cta{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:16px 18px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#0f0f0f;
      color:#fff;
      cursor:pointer;
      font-size:16px;
      font-weight:600;
    }
    .cta:disabled{
      background:#a9a9a9;
      cursor:not-allowed;
      border-color:#a9a9a9;
    }
    .small{font-size:12px;color:var(--muted);margin-top:8px}
    .tagline{color:var(--muted);font-size:12px;margin-top:8px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="toprow">
      <div class="pill" id="planPill">PLAN: —</div>
      <div class="pill" id="envPill">Allnspyre</div>
    </div>

    <h1>Tell me your vibe.</h1>
    <p class="sub">A few quick choices — then we’ll take you to checkout.</p>

    <!-- STEP 1 -->
    <div class="card section" id="step1">
      <div class="secTitle"><span class="n">1</span><span class="t">Where</span></div>
      <div class="hint" id="prefHint">Choose one prefecture.</div>

      <div class="grid2" id="prefGrid"></div>

      <div class="divider"></div>

      <div class="secTitle" style="margin-top:0"><span class="t">Now choose your area.</span></div>
      <div class="hint" id="areaHint">Pick your broad areas — we’ll build a richer route.</div>

      <div class="grid2" id="areaGrid"></div>
      <div class="row">
        <div class="counter" id="areaCounter">0/0</div>
        <div class="counter" id="areaLoading"></div>
      </div>
      <div class="error" id="areaError" style="display:none;"></div>
      <div class="tagline">Areas are shown as broad groups (easy for travelers).</div>
    </div>

    <!-- STEP 2 -->
    <div class="card section">
      <div class="secTitle"><span class="n">2</span><span class="t">Who</span></div>
      <div class="hint">Who are you eating with?</div>
      <div class="grid2" id="whoGrid"></div>
    </div>

    <!-- STEP 3 -->
    <div class="card section">
      <div class="secTitle"><span class="n">3</span><span class="t">Time & Mood</span></div>
      <div class="hint">What kind of time do you want? <b>Choose up to 2.</b></div>
      <div class="grid2" id="moodGrid"></div>
      <div class="row">
        <div class="counter" id="moodCounter">0/2</div>
      </div>
    </div>

    <!-- STEP 4 -->
    <div class="card section">
      <div class="secTitle"><span class="n">4</span><span class="t">Friction control</span></div>
      <div class="hint">Prefer to avoid? <span style="color:var(--muted)">(Optional)</span></div>
      <div class="grid2" id="avoidGrid"></div>
    </div>

    <!-- footer CTA -->
    <div class="footerBar">
      <button class="cta" id="continueBtn" disabled>
        <span>Continue to checkout</span>
        <span>→</span>
      </button>
      <div class="small" id="ctaNote">Select your prefecture and area to continue.</div>
    </div>
  </div>

<script>
(() => {
  // ----------------------------
  // Config
  // ----------------------------
  const PREFS = ["Tokyo","Kanagawa","Osaka","Kyoto","Hyogo","Nara","Fukuoka","Ishikawa"];

  // Values you store / pass
  const WHO = [
    { id:"solo", label:"Solo" },
    { id:"partner", label:"Partner" },
    { id:"friends", label:"Friends" },
    { id:"family", label:"Family" }
  ];
  const MOODS = [
    { id:"quiet_reflective", label:"Quiet & reflective" },
    { id:"slow_indulgent", label:"Slow & indulgent" },
    { id:"deeply_local", label:"Deeply local" },
    { id:"lively_social", label:"Lively & social" }
  ];
  const AVOIDS = [
    { id:"long_lines", label:"Long lines" },
    { id:"tourist_heavy", label:"Tourist-heavy places" },
    { id:"very_noisy", label:"Very noisy spots" }
  ];

  // Plan from URL: ?plan=explorer or ?plan=connoisseur
  const qs = new URLSearchParams(location.search);
  const plan = (qs.get("plan") || "explorer").toLowerCase();
  const isConnoisseur = plan === "connoisseur";

  // Limits
  const PREF_LIMIT = isConnoisseur ? 3 : 1;          // Connoisseur: up to 3 prefectures, Explorer: 1
  const AREA_LIMIT = isConnoisseur ? 4 : 1;          // Connoisseur: up to 4 broad areas, Explorer: 1 broad area

  // ----------------------------
  // State
  // ----------------------------
  const state = {
    prefs: [],           // ["Osaka", "Tokyo", ...]
    areaGroups: [],      // available area_group list from API
    areas: [],           // selected area_group(s)
    who: null,
    moods: [],
    avoids: []
  };

  // ----------------------------
  // Elements
  // ----------------------------
  const planPill = document.getElementById("planPill");
  const prefHint = document.getElementById("prefHint");
  const areaHint = document.getElementById("areaHint");
  const prefGrid = document.getElementById("prefGrid");
  const areaGrid = document.getElementById("areaGrid");
  const areaCounter = document.getElementById("areaCounter");
  const areaLoading = document.getElementById("areaLoading");
  const areaError = document.getElementById("areaError");
  const whoGrid = document.getElementById("whoGrid");
  const moodGrid = document.getElementById("moodGrid");
  const moodCounter = document.getElementById("moodCounter");
  const avoidGrid = document.getElementById("avoidGrid");
  const continueBtn = document.getElementById("continueBtn");
  const ctaNote = document.getElementById("ctaNote");

  // ----------------------------
  // UI builders
  // ----------------------------
  function chip(label, on, onClick, strong=false){
    const b = document.createElement("button");
    b.className = "chip" + (on ? (strong ? " onStrong" : " on") : "");
    b.type = "button";
    b.textContent = label;
    b.addEventListener("click", onClick);
    return b;
  }

  function renderPrefs(){
    prefGrid.innerHTML = "";
    PREFS.forEach(p => {
      const selected = state.prefs.includes(p);
      const b = chip(p, selected, () => togglePref(p));
      prefGrid.appendChild(b);
    });

    // Copy
    if (isConnoisseur){
      prefHint.textContent = "Choose up to 3 prefectures (recommended).";
    } else {
      prefHint.textContent = "Choose one prefecture.";
    }
  }

  function renderAreas(){
    areaGrid.innerHTML = "";
    const list = state.areaGroups || [];

    if (!list.length && state.prefs.length){
      areaError.style.display = "block";
      areaError.textContent = "No areas found for this selection.";
    } else {
      areaError.style.display = "none";
      areaError.textContent = "";
    }

    list.forEach(a => {
      const selected = state.areas.includes(a);
      const b = chip(a, selected, () => toggleArea(a));
      areaGrid.appendChild(b);
    });

    // Copy (limit)
    areaHint.textContent = isConnoisseur
      ? "Pick up to 4 broad areas — we’ll build a richer route."
      : "Pick one area — focused and fast.";

    areaCounter.textContent = `${state.areas.length}/${AREA_LIMIT}`;
  }

  function renderWho(){
    whoGrid.innerHTML = "";
    WHO.forEach(w => {
      const selected = state.who === w.id;
      const b = chip(w.label, selected, () => { state.who = w.id; sync(); }, selected);
      whoGrid.appendChild(b);
    });
  }

  function renderMoods(){
    moodGrid.innerHTML = "";
    MOODS.forEach(m => {
      const selected = state.moods.includes(m.id);
      const b = chip(m.label, selected, () => toggleMood(m.id));
      moodGrid.appendChild(b);
    });
    moodCounter.textContent = `${state.moods.length}/2`;
  }

  function renderAvoids(){
    avoidGrid.innerHTML = "";
    AVOIDS.forEach(a => {
      const selected = state.avoids.includes(a.id);
      const b = chip(a.label, selected, () => toggleAvoid(a.id));
      avoidGrid.appendChild(b);
    });
  }

  // ----------------------------
  // Toggle handlers
  // ----------------------------
  async function togglePref(p){
    const selected = state.prefs.includes(p);

    if (!isConnoisseur){
      // Explorer: single select prefecture
      state.prefs = selected ? [] : [p];
    } else {
      // Connoisseur: up to 3
      if (selected){
        state.prefs = state.prefs.filter(x => x !== p);
      } else {
        if (state.prefs.length >= PREF_LIMIT) return; // hard cap
        state.prefs = [...state.prefs, p];
      }
    }

    // When prefs change: reset area selections and refetch area groups
    state.areas = [];
    state.areaGroups = [];
    renderPrefs();
    renderAreas();
    await fetchAreaGroups();
    sync();
  }

  function toggleArea(a){
    const selected = state.areas.includes(a);

    if (!isConnoisseur){
      // Explorer: single select
      state.areas = selected ? [] : [a];
    } else {
      // Connoisseur: up to 4
      if (selected){
        state.areas = state.areas.filter(x => x !== a);
      } else {
        if (state.areas.length >= AREA_LIMIT) return;
        state.areas = [...state.areas, a];
      }
    }
    renderAreas();
    sync();
  }

  function toggleMood(id){
    const selected = state.moods.includes(id);
    if (selected){
      state.moods = state.moods.filter(x => x !== id);
    } else {
      if (state.moods.length >= 2) return;
      state.moods = [...state.moods, id];
    }
    renderMoods();
    sync();
  }

  function toggleAvoid(id){
    const selected = state.avoids.includes(id);
    state.avoids = selected ? state.avoids.filter(x => x !== id) : [...state.avoids, id];
    renderAvoids();
    sync();
  }

  // ----------------------------
  // API: fetch broad area groups
  // ----------------------------
  async function fetchJson(url){
    const r = await fetch(url, { cache: "no-store" });
    const text = await r.text();
    try { return JSON.parse(text); } catch(e){ return { ok:false, error:"Invalid JSON", raw:text }; }
  }

  async function fetchAreaGroups(){
    areaLoading.textContent = "";
    areaError.style.display = "none";
    areaError.textContent = "";

    if (!state.prefs.length){
      renderAreas();
      return;
    }

    areaLoading.textContent = "Loading areas…";

    // ---- Primary attempt: /api/areas?plan=...&prefs=Tokyo,Osaka
    const prefsParam = encodeURIComponent(state.prefs.join(","));
    const url1 = `/api/areas?plan=${encodeURIComponent(plan)}&prefs=${prefsParam}`;

    let data = await fetchJson(url1);

    // ---- Fallback: /api/areas?plan=...&pref=Tokyo (older shape)
    if (!data || data.ok !== true){
      const url2 = `/api/areas?plan=${encodeURIComponent(plan)}&pref=${encodeURIComponent(state.prefs[0])}`;
      data = await fetchJson(url2);
    }

    // Expected newer shape: { ok:true, areaGroups:[...] }
    // Older shape might be: { ok:true, areaDetails:[...] } -> we don't want it, but keep safe fallback
    if (data && data.ok === true){
      const groups = Array.isArray(data.areaGroups) ? data.areaGroups
                   : Array.isArray(data.area_details) ? data.area_details
                   : Array.isArray(data.areaDetails) ? data.areaDetails
                   : [];

      // unique + sort
      const uniq = Array.from(new Set(groups.map(x => String(x).trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      state.areaGroups = uniq;
      areaLoading.textContent = "";
      renderAreas();
      return;
    }

    // error
    areaLoading.textContent = "";
    state.areaGroups = [];
    renderAreas();

    areaError.style.display = "block";
    const msg = (data && (data.error || data.message)) ? (data.error || data.message) : "Failed to load areas.";
    areaError.textContent = msg + (data && data.details ? ` (${data.details})` : "");
  }

  // ----------------------------
  // Continue -> pay.html (checkout)
  // ----------------------------
  function canContinue(){
    const hasPref = state.prefs.length >= 1;
    const hasArea = state.areas.length >= 1;
    // Who/moods are not mandatory for moving to checkout (you can make them mandatory later)
    return hasPref && hasArea;
  }

  function updateCta(){
    const ok = canContinue();
    continueBtn.disabled = !ok;

    if (!state.prefs.length){
      ctaNote.textContent = "Select your prefecture to continue.";
    } else if (!state.areas.length){
      ctaNote.textContent = "Select your area to continue.";
    } else {
      ctaNote.textContent = "Ready. We’ll take you to checkout.";
    }
  }

  function buildPayload(){
    return {
      plan,
      prefs: state.prefs,
      areas: state.areas,      // area_group list (what you asked)
      who: state.who,
      moods: state.moods,
      avoid: state.avoids,
      v: 1,
      ts: Date.now()
    };
  }

  function goCheckout(){
    const payload = buildPayload();
    const q = new URLSearchParams();
    q.set("plan", plan);
    // Keep payload compact but safe
    q.set("payload", encodeURIComponent(JSON.stringify(payload)));
    // If your pay.html expects different params, change here ONLY.
    location.href = `/pay.html?${q.toString()}`;
  }

  continueBtn.addEventListener("click", () => {
    if (!canContinue()) return;
    goCheckout();
  });

  // ----------------------------
  // Sync (render + state display)
  // ----------------------------
  function sync(){
    planPill.textContent = `PLAN: ${plan.toUpperCase()}`;
    updateCta();
  }

  // ----------------------------
  // Init
  // ----------------------------
  renderPrefs();
  renderAreas();
  renderWho();
  renderMoods();
  renderAvoids();
  sync();

  // If URL has ?pref=Osaka (optional deep link)
  const deepPref = qs.get("pref");
  if (deepPref && PREFS.includes(deepPref)){
    state.prefs = isConnoisseur ? [deepPref] : [deepPref];
    renderPrefs();
    fetchAreaGroups().then(sync);
  }
})();
</script>
</body>
</html>
