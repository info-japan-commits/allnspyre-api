<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Allnspyre | Hearing</title>

<!-- GAタグ（必須） -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WPQTZYR6MG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-WPQTZYR6MG');
</script>

<style>
body{font-family:system-ui;background:#f7f5f1;margin:0;padding:40px}
.card{background:#fff;border:1px solid #eee;border-radius:16px;padding:20px;margin-bottom:20px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
button{padding:12px;border-radius:12px;border:1px solid #ddd;background:#fff;cursor:pointer}
button.active{border:2px solid #000}
.primary{background:#000;color:#fff;border:none;padding:14px 20px;border-radius:999px}
</style>
</head>

<body>

<h2>Choose Plan</h2>
<div class="card grid" id="planGrid">
<button data-plan="explorer">$19 Explorer</button>
<button data-plan="connoisseur">$39 Connoisseur</button>
</div>

<h2>Select Prefecture</h2>
<div class="card grid" id="prefGrid"></div>

<h2>Select Area</h2>
<div class="card grid" id="areaGrid"></div>

<h2>Who are you eating with?</h2>
<div class="card grid" id="whoGrid"></div>

<h2>Vibe (choose 1)</h2>
<div class="card grid" id="vibeGrid"></div>

<br>
<button class="primary" id="continueBtn">Continue to payment</button>

<script>
const PREFS = ["Tokyo","Kanagawa","Osaka","Kyoto","Hyogo","Nara","Fukuoka","Ishikawa"];
const WHO = ["solo","partner","friends","family"];
const VIBES = ["quiet_reflective","slow_indulgent","deeply_local","lively_social"];

let state = {
plan:null,
pref:null,
area:null,
who:null,
vibe:null
};

const planGrid = document.getElementById("planGrid");
const prefGrid = document.getElementById("prefGrid");
const areaGrid = document.getElementById("areaGrid");
const whoGrid = document.getElementById("whoGrid");
const vibeGrid = document.getElementById("vibeGrid");

function renderPrefs(){
prefGrid.innerHTML="";
PREFS.forEach(p=>{
const b=document.createElement("button");
b.textContent=p;
if(state.pref===p)b.classList.add("active");
b.onclick=()=>{state.pref=p;state.area=null;renderAll();loadAreas();}
prefGrid.appendChild(b);
});
}

async function loadAreas(){
if(!state.pref)return;
const r=await fetch(`/api/areas?prefectures=${state.pref}`);
const j=await r.json();
const list=j.areasByPrefecture?.[state.pref]||[];
areaGrid.innerHTML="";
list.forEach(a=>{
const b=document.createElement("button");
b.textContent=a;
if(state.area===a)b.classList.add("active");
b.onclick=()=>{state.area=a;renderAll();}
areaGrid.appendChild(b);
});
}

function renderWho(){
whoGrid.innerHTML="";
WHO.forEach(w=>{
const b=document.createElement("button");
b.textContent=w;
if(state.who===w)b.classList.add("active");
b.onclick=()=>{state.who=w;renderAll();}
whoGrid.appendChild(b);
});
}

function renderVibes(){
vibeGrid.innerHTML="";
VIBES.forEach(v=>{
const b=document.createElement("button");
b.textContent=v;
if(state.vibe===v)b.classList.add("active");
b.onclick=()=>{state.vibe=v;renderAll();}
vibeGrid.appendChild(b);
});
}

function renderPlan(){
[...planGrid.children].forEach(btn=>{
btn.classList.toggle("active",btn.dataset.plan===state.plan);
});
}

function renderAll(){
renderPlan();
renderPrefs();
renderWho();
renderVibes();
}

planGrid.addEventListener("click",e=>{
const btn=e.target.closest("button");
if(!btn)return;
state.plan=btn.dataset.plan;
renderAll();
});

function getGaClientId(){
return new Promise(resolve=>{
if(typeof gtag!=="function")return resolve("");
gtag("get","G-WPQTZYR6MG","client_id",cid=>resolve(cid||""));
});
}

document.getElementById("continueBtn").onclick=async()=>{
if(!state.plan||!state.pref||!state.area||!state.who||!state.vibe){
alert("Complete all selections");
return;
}

const ga_client_id=await getGaClientId();

const res=await fetch("/api/checkout",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
plan:state.plan,
prefectures:[state.pref],
area_groups:[state.area],
who:state.who,
vibes:[state.vibe],
ga_client_id
})
});

const j=await res.json();
location.href=j.url;
};

renderAll();
</script>
</body>
</html>
